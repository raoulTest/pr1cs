# Fix Thread Title Generation

## Problem
Thread titles are never generated. All threads show "Nouvelle conversation" in the sidebar. The chatbot itself works fine.

## Root Cause
Title generation is triggered **client-side** as fire-and-forget after streaming completes (`use-thread.ts:92-97`). Errors are silently swallowed with `.catch(console.error)`. If the `generateText()` call fails (model issue, API error, timeout), the title stays empty forever with no retry.

## Fix: Move Title Generation Server-Side

### File 1: `packages/backend/convex/ai/chat.ts`

1. **Change import**: Add `internalAction` to the server import
   ```typescript
   import { action, internalAction } from "../_generated/server";
   ```

2. **Convert `generateThreadTitle` from `action` to `internalAction`**: This makes it non-callable from the client and schedulable by the server.

3. **Add error handling with fallback**: Wrap `generateText` in try/catch. On failure, fall back to using the first ~5 words of the user's message as the title. This guarantees a title is always set.

4. **Change `maxOutputTokens` to `maxTokens`**: AI SDK v5 uses `maxTokens`, not `maxOutputTokens`.

5. **Schedule title generation at end of `initiateStream`**: After `apcsAgent.streamText()` completes, check if thread has no title, then use `ctx.scheduler.runAfter(0, ...)` to trigger `generateThreadTitle`. This runs server-side, asynchronously, with automatic retry on failure.

### File 2: `apps/web/src/features/chat/hooks/use-thread.ts`

1. **Remove** the `generateTitleAction` declaration (line 44)
2. **Remove** the fire-and-forget title generation block (lines 91-97)
3. **Remove** `generateTitleAction` from the `useCallback` dependency array (line 107)

## Files to Modify
- `packages/backend/convex/ai/chat.ts` (main fix)
- `apps/web/src/features/chat/hooks/use-thread.ts` (cleanup)

## Verification
1. Start the dev server and open the chat
2. Send a first message in a new thread
3. After the AI responds, the thread title in the sidebar should update from "Nouvelle conversation" to an AI-generated French title
4. Check Convex dashboard logs for `generateThreadTitle` execution (should succeed without errors)
5. Test: close the tab immediately after sending a message, then reopen -- the title should still be generated (server-side)
