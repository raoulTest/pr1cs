# Plan: Correction de la liste des opérateurs dans l'admin

## Problème identifié

La fonction `listByRole` dans `packages/backend/convex/users/queries.ts` (lignes 192-240) ne retourne pas les opérateurs car elle dépend de la table `userProfiles` pour trouver les utilisateurs:

```typescript
// PROBLÈME: Cherche d'abord dans userProfiles
const profiles = await ctx.db.query("userProfiles").collect();

// Puis filtre par rôle
const result = await Promise.all(
  profiles.map(async (profile) => {
    const authUser = await authComponent.getAnyUserById(ctx, profile.userId);
    // ...
  }),
);
```

Les utilisateurs avec le rôle `terminal_operator` qui n'ont pas encore de profil dans `userProfiles` ne sont donc pas retournés.

## Solution

Utiliser `components.betterAuth.users.listByRole` qui existe déjà dans `packages/backend/convex/betterAuth/users.ts` et qui interroge directement la table `user` du composant Better Auth.

## Fichiers à modifier

1. **`packages/backend/convex/users/queries.ts`** - Modifier `listByRole` (lignes 192-240)

## Modification

Remplacer l'implémentation actuelle par:

```typescript
export const listByRole = query({
  args: { role: apcsRoleValidator },
  returns: v.array(
    v.object({
      userId: v.string(),
      email: v.string(),
      name: v.optional(v.string()),
      role: betterAuthRoleValidator,
      preferredLanguage: v.optional(languageValidator),
      createdAt: v.optional(v.number()),
    }),
  ),
  handler: async (ctx, args) => {
    const user = await getAuthenticatedUser(ctx);
    requireRole(user, ["port_admin"]);

    // Utiliser directement le composant Better Auth pour lister par rôle
    const authUsers = await ctx.runQuery(
      components.betterAuth.users.listByRole,
      { role: args.role },
    );

    // Récupérer les profils pour les préférences (optionnel)
    const profiles = await ctx.db.query("userProfiles").collect();
    const profileMap = new Map(profiles.map((p) => [p.userId, p]));

    return authUsers.map((authUser) => {
      const profile = profileMap.get(authUser._id);
      return {
        userId: authUser._id,
        email: authUser.email,
        name: authUser.name,
        role: authUser.role as
          | "port_admin"
          | "terminal_operator"
          | "carrier"
          | "user",
        preferredLanguage: profile?.preferredLanguage,
        createdAt: authUser.createdAt,
      };
    });
  },
});
```

## Vérification

1. Lancer le serveur de développement: `pnpm dev`
2. Se connecter en tant qu'admin
3. Aller dans la page `/admin/operators`
4. Vérifier que les utilisateurs avec le rôle `terminal_operator` s'affichent même sans profil `userProfiles`
