# APCS Frontend Implementation Plan

**Date:** 2026-02-07  
**Status:** Planning  
**Scope:** Chat-centric interface + Full traditional routes for all roles

---

## Executive Summary

Implement a French-only frontend for APCS (Advanced Port Container System) with two major parts:

1. **Chat-centric interface** - AI assistant as the primary interaction method with custom tool renderers
2. **Traditional routes** - Full CRUD pages for admin, operator, and carrier roles with sidebar navigation

Both interfaces share authentication and use consistent design patterns (TanStack Table, TanStack Form + Zod, shadcn/ui components).

---

## Key Decisions (Confirmed)

### Chat Interface

| Decision               | Choice                                                |
| ---------------------- | ----------------------------------------------------- |
| Layout approach        | Chat-centric for `/_chat/*` routes                    |
| Tool display           | Custom inline renderers with expand icon → dialog     |
| Sidebar menus          | Role-specific navigation items                        |
| Interactive components | Quick action buttons to insert chat responses         |
| Thread list            | Grouped by date (Today, Yesterday, Last 7 days, etc.) |
| Sidebar behavior       | Collapsible with toggle button                        |
| User identity          | Sidebar footer with dropdown                          |
| Thread titles          | AI-generated from first message                       |
| New thread             | Both: button + automatic on input                     |
| Streaming              | Convex-native (subscriptions)                         |
| Fullscreen expand      | Dialog/sheet overlay                                  |

### Traditional Routes

| Decision          | Choice                                             |
| ----------------- | -------------------------------------------------- |
| Layout            | Sidebar + Content (no chat for now)                |
| Admin management  | Full CRUD with TanStack Table                      |
| User management   | Include full page for role/terminal assignment     |
| Carrier bookings  | Calendar view                                      |
| Carrier trucks    | Dialog forms for CRUD                              |
| Operator pending  | Approval queue with approve/reject buttons         |
| Operator capacity | 168 slots week view (blue=active, red=inactive)    |
| Forms             | TanStack Form + Zod                                |
| Data tables       | TanStack Table with sorting, filtering, pagination |

### Global

| Decision    | Choice                                        |
| ----------- | --------------------------------------------- |
| UI language | French only                                   |
| Auth flow   | Login page redirect for unauthenticated users |

---

## Architecture Overview

### File Structure

```
apps/web/src/
├── routes/
│   ├── __root.tsx                    # Root layout (minimal)
│   ├── login.tsx                     # Login page
│   │
│   ├── _chat.tsx                     # Chat layout route
│   ├── _chat/
│   │   ├── index.tsx                 # Default: new thread or redirect
│   │   └── $threadId.tsx             # Specific thread view
│   │
│   ├── _dashboard.tsx                # Traditional routes layout
│   ├── _dashboard/
│   │   ├── admin/
│   │   │   ├── terminals.tsx         # Terminal CRUD
│   │   │   ├── carriers.tsx          # Carrier management
│   │   │   ├── trucks.tsx            # All trucks view
│   │   │   ├── gates.tsx             # Gate CRUD
│   │   │   ├── bookings.tsx          # All bookings table
│   │   │   ├── users.tsx             # User role management
│   │   │   └── config.tsx            # System configuration
│   │   │
│   │   ├── operator/
│   │   │   ├── index.tsx             # Terminal overview
│   │   │   ├── bookings.tsx          # Terminal bookings
│   │   │   ├── pending.tsx           # Approval queue
│   │   │   └── capacity.tsx          # 168 slots week view
│   │   │
│   │   └── carrier/
│   │       ├── bookings.tsx          # Calendar view
│   │       ├── trucks.tsx            # My trucks CRUD
│   │       └── containers.tsx        # My containers view
│
├── features/
│   ├── chat/                         # Chat feature module
│   │   ├── index.ts
│   │   ├── components/
│   │   │   ├── chat-layout.tsx
│   │   │   ├── chat-sidebar.tsx
│   │   │   ├── chat-sidebar-nav.tsx
│   │   │   ├── chat-sidebar-threads.tsx
│   │   │   ├── chat-sidebar-footer.tsx
│   │   │   ├── chat-view.tsx
│   │   │   ├── chat-messages.tsx
│   │   │   ├── chat-message-item.tsx
│   │   │   ├── chat-input.tsx
│   │   │   └── chat-empty-state.tsx
│   │   ├── hooks/
│   │   │   ├── use-chat.ts
│   │   │   ├── use-thread.ts
│   │   │   └── use-threads.ts
│   │   ├── lib/
│   │   │   ├── thread-utils.ts
│   │   │   └── message-parser.ts
│   │   └── types.ts
│   │
│   ├── tools/                        # Tool renderers for chat
│   │   ├── index.ts
│   │   ├── registry.tsx
│   │   ├── components/
│   │   │   ├── tool-wrapper.tsx
│   │   │   ├── tool-dialog.tsx
│   │   │   ├── tool-actions.tsx
│   │   │   ├── bookings/
│   │   │   │   ├── booking-list.tsx
│   │   │   │   ├── booking-card.tsx
│   │   │   │   └── pending-bookings.tsx
│   │   │   ├── terminals/
│   │   │   │   ├── terminal-list.tsx
│   │   │   │   ├── terminal-card.tsx
│   │   │   │   └── available-slots.tsx
│   │   │   ├── suggestions/
│   │   │   │   └── optimal-slots.tsx
│   │   │   ├── containers/
│   │   │   │   ├── container-list.tsx
│   │   │   │   └── container-card.tsx
│   │   │   ├── trucks/
│   │   │   │   └── truck-list.tsx
│   │   │   ├── config/
│   │   │   │   └── system-config.tsx
│   │   │   └── mutations/
│   │   │       ├── booking-created.tsx
│   │   │       └── booking-cancelled.tsx
│   │   └── types.ts
│   │
│   ├── dashboard/                    # Traditional dashboard feature
│   │   ├── index.ts
│   │   ├── components/
│   │   │   ├── dashboard-layout.tsx
│   │   │   ├── dashboard-sidebar.tsx
│   │   │   ├── dashboard-nav.tsx
│   │   │   └── dashboard-header.tsx
│   │   └── hooks/
│   │       └── use-role-guard.ts
│   │
│   ├── admin/                        # Admin-specific features
│   │   ├── components/
│   │   │   ├── terminals/
│   │   │   │   ├── terminal-table.tsx
│   │   │   │   ├── terminal-form.tsx
│   │   │   │   └── terminal-dialog.tsx
│   │   │   ├── carriers/
│   │   │   │   ├── carrier-table.tsx
│   │   │   │   └── carrier-details.tsx
│   │   │   ├── gates/
│   │   │   │   ├── gate-table.tsx
│   │   │   │   ├── gate-form.tsx
│   │   │   │   └── gate-dialog.tsx
│   │   │   ├── users/
│   │   │   │   ├── user-table.tsx
│   │   │   │   ├── role-select.tsx
│   │   │   │   └── terminal-assignment.tsx
│   │   │   ├── bookings/
│   │   │   │   └── bookings-table.tsx
│   │   │   └── config/
│   │   │       └── config-form.tsx
│   │   └── schemas/
│   │       ├── terminal.schema.ts
│   │       ├── gate.schema.ts
│   │       └── config.schema.ts
│   │
│   ├── operator/                     # Operator-specific features
│   │   ├── components/
│   │   │   ├── terminal-overview.tsx
│   │   │   ├── pending-queue.tsx
│   │   │   ├── pending-card.tsx
│   │   │   ├── capacity-grid.tsx      # 168 slots week view
│   │   │   ├── capacity-slot.tsx
│   │   │   └── bookings-table.tsx
│   │   └── hooks/
│   │       └── use-terminal-data.ts
│   │
│   └── carrier/                      # Carrier-specific features
│       ├── components/
│       │   ├── booking-calendar.tsx
│       │   ├── calendar-event.tsx
│       │   ├── truck-grid.tsx
│       │   ├── truck-card.tsx
│       │   ├── truck-form.tsx
│       │   ├── truck-dialog.tsx
│       │   └── container-list.tsx
│       └── schemas/
│           └── truck.schema.ts
│
├── components/
│   ├── ui/                           # shadcn/ui (existing)
│   ├── ai-elements/                  # AI Elements (existing)
│   └── shared/
│       ├── data-table.tsx            # Reusable TanStack Table
│       ├── data-table-pagination.tsx
│       ├── data-table-toolbar.tsx
│       ├── data-table-column-header.tsx
│       ├── form-field.tsx            # TanStack Form wrapper
│       ├── role-guard.tsx
│       ├── loading-skeleton.tsx
│       └── page-header.tsx
│
└── hooks/
    ├── use-media-query.ts
    └── use-role.ts
```

---

## Route Structure

### Chat Routes

| Route              | Description            | Access        |
| ------------------ | ---------------------- | ------------- |
| `/_chat`           | Chat layout wrapper    | Authenticated |
| `/_chat/`          | New thread or redirect | Authenticated |
| `/_chat/$threadId` | Specific thread        | Authenticated |

### Admin Routes (`port_admin` only)

| Route                         | Description                                   |
| ----------------------------- | --------------------------------------------- |
| `/_dashboard/admin/terminals` | Terminal CRUD (TanStack Table + Dialog forms) |
| `/_dashboard/admin/carriers`  | Carrier list with container assignment        |
| `/_dashboard/admin/trucks`    | All trucks view (read-only table)             |
| `/_dashboard/admin/gates`     | Gate CRUD (TanStack Table + Dialog forms)     |
| `/_dashboard/admin/bookings`  | All bookings table with filters               |
| `/_dashboard/admin/users`     | User role management + terminal assignment    |
| `/_dashboard/admin/config`    | System configuration form                     |

### Operator Routes (`terminal_operator` only)

| Route                           | Description                                     |
| ------------------------------- | ----------------------------------------------- |
| `/_dashboard/operator/`         | Terminal overview dashboard                     |
| `/_dashboard/operator/bookings` | Bookings for assigned terminals                 |
| `/_dashboard/operator/pending`  | Approval queue (approve/reject)                 |
| `/_dashboard/operator/capacity` | 168 slots week grid (blue=active, red=inactive) |

### Carrier Routes (`carrier` only)

| Route                            | Description                               |
| -------------------------------- | ----------------------------------------- |
| `/_dashboard/carrier/bookings`   | Calendar view of my bookings              |
| `/_dashboard/carrier/trucks`     | My trucks CRUD (card grid + dialog forms) |
| `/_dashboard/carrier/containers` | My containers (read-only list)            |

### Public Routes

| Route    | Description       |
| -------- | ----------------- |
| `/login` | Login/signup page |

---

## Component Hierarchy

### Chat Layout

```
/_chat → ChatLayout
├── ChatSidebar (collapsible)
│   ├── ChatSidebarHeader (logo + new thread button)
│   ├── ChatSidebarNav (role-specific links → dashboard routes)
│   ├── Separator
│   ├── ChatSidebarThreads (grouped by date)
│   └── ChatSidebarFooter (user dropdown)
│
└── Main Content
    ├── Header (toggle button only)
    └── Outlet
        └── ChatView
            ├── Conversation (AI Elements)
            │   ├── ConversationContent → ChatMessages
            │   └── ConversationScrollButton
            └── ChatInput (PromptInput + Suggestions)
```

### Dashboard Layout

```
/_dashboard → DashboardLayout
├── DashboardSidebar (fixed left)
│   ├── Logo + "Retour au chat" link
│   ├── Separator
│   ├── DashboardNav (role-specific section links)
│   └── Footer (user dropdown)
│
└── Main Content
    ├── DashboardHeader (breadcrumbs + page actions)
    └── Outlet
        └── Page Content (tables, forms, etc.)
```

---

## Traditional Routes - Detailed Specifications

### Admin: Terminals (`/admin/terminals`)

- **View**: TanStack Table with columns: Name, Code, Timezone, Status, Capacity, Actions
- **Create**: Dialog with TanStack Form (name, code, timezone, operating hours, capacity)
- **Edit**: Same dialog pre-filled
- **Delete**: Confirmation dialog (soft delete via deactivate)
- **Filters**: Status (active/inactive), search by name/code

### Admin: Carriers (`/admin/carriers`)

- **View**: TanStack Table with columns: Name, Email, Truck Count, Container Count, Actions
- **Details**: Expandable row or dialog showing trucks and containers
- **Assign Containers**: Dialog to transfer containers to carrier
- **No Create/Edit**: Carriers are created via signup

### Admin: Gates (`/admin/gates`)

- **View**: TanStack Table with columns: Name, Code, Terminal, Allowed Types, Status, Actions
- **Create**: Dialog with form (name, code, terminal select, truck types multiselect)
- **Edit**: Same dialog pre-filled
- **Group by**: Terminal (collapsible sections)

### Admin: Bookings (`/admin/bookings`)

- **View**: TanStack Table with all bookings
- **Columns**: Reference, Carrier, Terminal, Date, Time, Status, Actions
- **Filters**: Status, Terminal, Date range, Carrier
- **Actions**: View details (dialog), Cancel (if applicable)

### Admin: Users (`/admin/users`)

- **View**: TanStack Table with columns: Name, Email, Role, Terminals (for operators), Actions
- **Role Assignment**: Dropdown to change role
- **Terminal Assignment**: Dialog with checkbox list (for terminal_operator role)
- **Filters**: By role

### Admin: Config (`/admin/config`)

- **View**: Form with system configuration
- **Fields**: maxAdvanceBookingDays, minAdvanceBookingHours, noShowGracePeriod, etc.
- **Save**: Single save button for all fields

### Operator: Overview (`/operator/`)

- **Dashboard Cards**:
  - Pending bookings count
  - Today's confirmed bookings
  - Capacity utilization %
  - Recent activity

### Operator: Bookings (`/operator/bookings`)

- **View**: TanStack Table filtered to operator's terminals
- **Columns**: Reference, Carrier, Date, Time, Status, Gate, Actions
- **Actions**: View details, Confirm (if pending), Mark consumed

### Operator: Pending (`/operator/pending`)

- **View**: Approval queue (card-based, not table)
- **Each Card**: Booking reference, carrier, containers, requested time, expand for details
- **Actions**: Approve button (green), Reject button (red) with reason dialog
- **Sort**: Oldest first (FIFO)

### Operator: Capacity (`/operator/capacity`)

- **View**: Week grid (7 columns x 24 rows = 168 cells)
- **Each Cell**: Slot template for that hour
- **Colors**: Blue = active, Red = inactive
- **Click**: Toggle active/inactive or open dialog to edit capacity
- **Header**: Day names (Lundi, Mardi, etc.)
- **Row Labels**: Hours (00:00, 01:00, etc.)

### Carrier: Bookings (`/carrier/bookings`)

- **View**: Calendar (week or month view)
- **Events**: Booking blocks showing reference, terminal, status
- **Click Event**: Open booking details dialog
- **Status Colors**: Pending (yellow), Confirmed (green), Consumed (gray), Cancelled (red)
- **Navigation**: Previous/Next week, Today button

### Carrier: Trucks (`/carrier/trucks`)

- **View**: Card grid (not table)
- **Each Card**: License plate, type, class, status badge, edit/delete buttons
- **Create**: Dialog with form (license plate, type, class, make, model, year)
- **Edit**: Same dialog pre-filled
- **Delete**: Confirmation dialog (deactivate)

### Carrier: Containers (`/carrier/containers`)

- **View**: Card grid or simple list
- **Each Card**: Container number, type, dimensions, operation type, status
- **Read-only**: No create/edit (assigned by admin)
- **Filter**: By operation type (pick_up, drop_off), availability

---

## Sidebar Navigation by Role

### Port Admin

| Label         | Route              | Icon     |
| ------------- | ------------------ | -------- |
| Terminaux     | `/admin/terminals` | Building |
| Transporteurs | `/admin/carriers`  | Users    |
| Camions       | `/admin/trucks`    | Truck    |
| Portails      | `/admin/gates`     | DoorOpen |
| Réservations  | `/admin/bookings`  | Calendar |
| Utilisateurs  | `/admin/users`     | UserCog  |
| Configuration | `/admin/config`    | Settings |

### Terminal Operator

| Label          | Route                | Icon            |
| -------------- | -------------------- | --------------- |
| Vue d'ensemble | `/operator/`         | LayoutDashboard |
| Réservations   | `/operator/bookings` | Calendar        |
| En attente     | `/operator/pending`  | Clock           |
| Capacité       | `/operator/capacity` | Grid            |

### Carrier

| Label            | Route                 | Icon      |
| ---------------- | --------------------- | --------- |
| Mes réservations | `/carrier/bookings`   | Calendar  |
| Mes camions      | `/carrier/trucks`     | Truck     |
| Mes conteneurs   | `/carrier/containers` | Container |

---

## Tool Renderers (Chat Interface)

All tools will have custom renderers with:

1. **Inline display** in chat with summary view
2. **Expand icon** (top-right) → opens Dialog with full content
3. **Quick action buttons** that insert responses into chat

| Tool Name                | Component        | Quick Actions                |
| ------------------------ | ---------------- | ---------------------------- |
| `listMyBookings`         | BookingList      | "Voir détails", "Annuler"    |
| `getBookingDetails`      | BookingCard      | "Annuler", "Modifier camion" |
| `listPendingBookings`    | PendingBookings  | "Approuver", "Refuser"       |
| `listBookingsByTerminal` | BookingList      | "Voir détails"               |
| `listBookingsByCarrier`  | BookingList      | "Voir détails"               |
| `listTerminals`          | TerminalList     | "Voir créneaux"              |
| `getTerminalDetails`     | TerminalCard     | "Voir créneaux disponibles"  |
| `getAvailableSlots`      | AvailableSlots   | Slot selection buttons       |
| `suggestOptimalSlots`    | OptimalSlots     | "Réserver ce créneau"        |
| `listMyContainers`       | ContainerList    | "Réserver avec ce conteneur" |
| `getContainerDetails`    | ContainerCard    | "Réserver"                   |
| `listMyTrucks`           | TruckList        | "Utiliser ce camion"         |
| `getSystemConfig`        | SystemConfig     | None                         |
| `createBookingViaAI`     | BookingCreated   | "Voir QR Code", "Annuler"    |
| `cancelBookingViaAI`     | BookingCancelled | "Nouvelle réservation"       |

---

## Shared Components

### DataTable (Reusable TanStack Table)

```typescript
// components/shared/data-table.tsx
interface DataTableProps<TData, TValue> {
  columns: ColumnDef<TData, TValue>[];
  data: TData[];
  searchKey?: string;
  searchPlaceholder?: string;
  filterColumn?: string;
  filterOptions?: { label: string; value: string }[];
  pageSize?: number;
  onRowClick?: (row: TData) => void;
}
```

### FormField (TanStack Form + Zod wrapper)

```typescript
// components/shared/form-field.tsx
interface FormFieldProps {
  form: UseFormReturn<any>;
  name: string;
  label: string;
  type?: "text" | "number" | "select" | "multiselect" | "switch" | "textarea";
  options?: { label: string; value: string }[];
  placeholder?: string;
  description?: string;
}
```

---

## Backend Additions Required

### 1. List User Threads Query

```typescript
// convex/ai/queries.ts
export const listUserThreads = query({
  args: { userId: v.string() },
  handler: async (ctx, args) => {
    // Use @convex-dev/agent API to list threads
  },
});
```

### 2. Update Thread Title Mutation

```typescript
// convex/ai/mutations.ts
export const updateThreadTitle = mutation({
  args: { threadId: v.string(), title: v.string() },
  handler: async (ctx, args) => {
    // Update thread metadata
  },
});
```

---

## Dependencies to Add

```bash
# TanStack Table for data tables
bun add @tanstack/react-table

# TanStack Form for forms (may already be installed from native app)
bun add @tanstack/react-form

# Calendar component (for carrier bookings)
# Option 1: Use shadcn calendar + custom week view
# Option 2: Add a dedicated calendar library
bun add @fullcalendar/react @fullcalendar/daygrid @fullcalendar/timegrid
```

---

## Implementation Phases

### Phase 1: Core Infrastructure (Day 1-2)

1. Modify `__root.tsx` for layout routing
2. Create `routes/login.tsx` with Better Auth
3. Create shared components:
   - `data-table.tsx` + pagination + toolbar
   - `form-field.tsx` wrapper
   - `page-header.tsx`
   - `role-guard.tsx`
4. Create `DashboardLayout` with sidebar
5. Create `DashboardSidebar` with role-based nav

### Phase 2: Chat Interface (Day 3-4)

1. Create `ChatLayout` with collapsible sidebar
2. Create `ChatSidebar` components
3. Create `useChat`, `useThread`, `useThreads` hooks
4. Create `ChatView`, `ChatMessages`, `ChatInput`
5. Add backend queries for thread management

### Phase 3: Tool Renderers (Day 5-6)

1. Create `ToolWrapper` with expand functionality
2. Create `ToolRegistry` with all mappings
3. Implement all 15 tool renderers:
   - Booking tools (3)
   - Terminal tools (3)
   - Container tools (2)
   - Truck tools (1)
   - Config tools (1)
   - Mutation results (2)
   - Suggestions (1)
   - Admin-only (2)

### Phase 4: Admin Pages (Day 7-8)

1. `/admin/terminals` - Full CRUD
2. `/admin/gates` - Full CRUD
3. `/admin/carriers` - List + container assignment
4. `/admin/trucks` - Read-only table
5. `/admin/bookings` - Table with filters
6. `/admin/users` - Role + terminal assignment
7. `/admin/config` - Configuration form

### Phase 5: Operator Pages (Day 9-10)

1. `/operator/` - Overview dashboard
2. `/operator/bookings` - Bookings table
3. `/operator/pending` - Approval queue
4. `/operator/capacity` - 168 slots week grid

### Phase 6: Carrier Pages (Day 11-12)

1. `/carrier/bookings` - Calendar view
2. `/carrier/trucks` - Card grid + CRUD dialogs
3. `/carrier/containers` - Read-only list

### Phase 7: Polish & Testing (Day 13-14)

1. Mobile responsiveness (Sheet sidebars)
2. Loading states / skeletons
3. Error boundaries
4. Form validation messages
5. French language verification
6. End-to-end testing all flows

---

## Critical Files to Modify

| File                                      | Modification                              |
| ----------------------------------------- | ----------------------------------------- |
| `apps/web/src/routes/__root.tsx`          | Minimal layout, route-based child layouts |
| `apps/web/package.json`                   | Add TanStack Table, Form, Calendar deps   |
| `packages/backend/convex/ai/queries.ts`   | Add `listUserThreads`                     |
| `packages/backend/convex/ai/mutations.ts` | Add `updateThreadTitle`                   |

---

## Verification Steps

### Login Flow

- Visit any route → redirect to `/login`
- Login → redirect to `/_chat`
- Logout → redirect to `/login`

### Chat Interface

- New thread creation (button + automatic)
- Messages stream in real-time
- Tool calls render with custom components
- Expand button opens dialog
- Quick actions insert messages
- Sidebar navigation opens dashboard routes

### Admin Pages

- Terminals: Create, edit, delete, filter, search
- Gates: Create, edit, delete, group by terminal
- Carriers: List, view details, assign containers
- Users: Change roles, assign terminals to operators
- Bookings: Filter by status/terminal/date
- Config: Edit and save all settings

### Operator Pages

- Overview: See dashboard stats
- Bookings: View terminal bookings
- Pending: Approve/reject with reason
- Capacity: Toggle slots, see blue/red colors

### Carrier Pages

- Bookings: Calendar navigation, click events
- Trucks: Create, edit, delete trucks
- Containers: View assigned containers

### Mobile Responsive

- Chat sidebar becomes Sheet
- Dashboard sidebar becomes Sheet
- Tables responsive (horizontal scroll)
- Forms stack vertically

---

## Notes

- All UI text in **French**
- All forms use **TanStack Form + Zod** for validation (refer to skill)
- All tables use **TanStack Table** for features
- Quick actions designed to **guide users, for example toward port-optimal slots**
- Capacity grid: **Blue = active (bookable), Red = inactive (closed)**
- Calendar: Consider FullCalendar or custom implementation with shadcn
