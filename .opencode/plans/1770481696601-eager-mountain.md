# Plan: QR Code Generation pour les Reservations

## Objectif
Generer et afficher un QR code pour chaque reservation confirmee:
1. Dans le `BookingConfirmationRenderer` (conversation AI) quand une reservation est auto-validee
2. Dans le dialog detail du `BookingCalendar` (onglet "Mes reservations" du carrier)

## Approche: Generation Frontend avec `qrcode.react`

Le QR code encode uniquement la reference de reservation (ex: `TER1-BK-000001`), qui est deja disponible cote frontend dans les deux contextes d'affichage. Pas besoin de generation serveur ni de stockage.

**Pourquoi frontend-only:**
- La reference est deja disponible dans `BookingConfirmationRenderer.result.bookingReference` et `BookingCalendar.selectedBooking.bookingReference`
- Compatible avec le scan existant (`scanEntry` cherche par `bookingReference`)
- Pas de contrainte runtime V8/Node.js a gerer
- Rendu instantane, pas de latence

## Fichiers a modifier

### 1. Installer `qrcode.react`
- `apps/web/package.json` — ajouter la dependance

### 2. Creer un composant QR partage
- **Nouveau**: `apps/web/src/components/ui/booking-qr-code.tsx`
- Wrapper autour de `QRCodeSVG` avec fond blanc, padding, et reference en texte dessous
- Props: `bookingReference: string`, `size?: number` (default 128)

### 3. QR dans la conversation (BookingConfirmationRenderer)
- **Modifier**: `apps/web/src/features/tools/components/booking-confirmation.tsx`
- Ajouter le QR code apres les infos date/heure/terminal, conditionne par `result.status === "confirmed"` et `!isCancel`
- Import `BookingQRCode`

### 4. QR dans le dialog detail des reservations (BookingCalendar)
- **Modifier**: `apps/web/src/features/carrier/components/booking-calendar.tsx`
- Ajouter le QR code en bas du dialog, conditionne par `status === "confirmed" || status === "consumed"`
- Taille plus grande (160px) car le dialog est plus spacieux
- Import `BookingQRCode`

### 5. Nettoyage backend (placeholder)
- **Modifier**: `packages/backend/convex/bookings/mutations.ts` — retirer `qrCode: generateQRCodePlaceholder(...)` de la creation et l'import
- **Modifier**: `packages/backend/convex/bookings/internal.ts` — supprimer la fonction `generateQRCodePlaceholder`
- Schema (`qrCode`, `qrCodeStorageId`): laisser en place (champs optionnels, pas de migration necessaire)

## Regles d'affichage
- QR visible uniquement pour `status === "confirmed"` dans le chat
- QR visible pour `status === "confirmed"` ou `"consumed"` dans le dialog calendrier
- Jamais de QR pour `pending`, `rejected`, `cancelled`, `expired`
- Fond blanc force (`bg-white`) pour la scanabilite en dark mode

## Verification
1. Creer une reservation via le chat AI → si auto-validee, le QR doit apparaitre dans la carte de confirmation
2. Creer une reservation pending, puis la confirmer manuellement → le QR doit apparaitre dans le dialog du calendrier
3. Verifier que le QR n'apparait PAS pour les reservations pending/rejected/cancelled
4. Scanner le QR genere → doit retourner la reference de booking exacte
