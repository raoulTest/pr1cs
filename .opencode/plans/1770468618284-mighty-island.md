# Generative UI for Tool Calls - Implementation Plan

## Overview

Implement a rich, interactive UI system for AI tool calls in the chat. Instead of showing raw text results, tools will render beautiful, interactive components directly in the conversation.

## Current State

- **Tool Renderers Exist**: `TOOL_RENDERERS` registry in `/apps/web/src/features/tools/index.ts` with 17 components
- **NOT Connected**: `chat-message-item.tsx` only shows basic `"toolName - En cours..."` text
- **UI Components Ready**: Card, Dialog, Sheet, Calendar, Select, etc. all available in shadcn/ui

## User Requirements Summary

| Feature | Decision |
|---------|----------|
| Large results | Summary + Expand (80% screen modal) |
| Preview items | 3 items before expand |
| Loading state | Skeleton placeholders |
| Error display | Inline error card |
| Mutations | Always ask confirmation FIRST |
| Confirmation UI | Card with pre-filled data + Confirm/Cancel buttons |
| Slot selection | Clickable slots, auto-send message to AI |
| Input forms | AI message with form below text |
| Inline actions | Action buttons row, context-sensitive |
| Actions scope | Per-item when relevant |
| Mobile | Responsive cards |
| Theme | Follow app theme (light/dark) |

---

## Architecture

```
ChatView
├── ToolUIProvider (context)              <- NEW: Manages modals, sends messages
│   ├── ToolExpandSheet                   <- NEW: 80% width slide-over
│   └── ConfirmationDialog                <- NEW: Mutation confirmation
│
├── ChatMessages
│   └── ChatMessageItem                   <- MODIFY: Use ToolCallRenderer
│       └── ToolCallRenderer              <- NEW: Orchestrator component
│           ├── ToolLoadingState          <- NEW: Skeleton cards
│           ├── ToolErrorState            <- NEW: Error cards
│           └── [Specific Renderer]       <- UPGRADE: Add interactions
│               ├── Summary view (3 items + expand)
│               ├── Clickable items
│               └── Action buttons row
│
└── ChatInput (unchanged)
```

---

## Implementation Phases

### Phase 1: Core Infrastructure (2-3 hours)

**Files to Create:**
1. `apps/web/src/features/tools/types.ts` - New type definitions
2. `apps/web/src/features/tools/context/tool-ui-context.tsx` - Context provider
3. `apps/web/src/features/tools/components/tool-call-renderer.tsx` - Orchestrator
4. `apps/web/src/features/tools/components/tool-loading-state.tsx` - Skeleton
5. `apps/web/src/features/tools/components/tool-error-state.tsx` - Error card
6. `apps/web/src/features/tools/components/tool-expand-sheet.tsx` - 80% modal
7. `apps/web/src/features/tools/components/confirmation-dialog.tsx` - Confirmation

**Files to Modify:**
1. `apps/web/src/features/tools/index.ts` - Rename to `registry.ts`, add metadata
2. `apps/web/src/features/chat/components/chat-view.tsx` - Wrap with ToolUIProvider
3. `apps/web/src/features/chat/components/chat-message-item.tsx` - Use ToolCallRenderer

### Phase 2: Upgrade Renderers (3-4 hours)

Upgrade each renderer with:
- `previewOnly` and `previewCount` props for summary mode
- `expanded` prop for full view in modal
- `onAction` and `onSelect` handlers for interactivity
- Action buttons row for relevant items
- Click handlers for selectable items

**Renderers to Upgrade:**
1. `booking-list.tsx` - Add cancel/view actions per booking
2. `booking-details.tsx` - Add cancel action for pending
3. `slot-availability.tsx` - Make slots clickable with auto-send
4. `terminal-list.tsx` - Make terminals selectable
5. `container-list.tsx` - Add view details action
6. `truck-list.tsx` - Add view details action
7. `booking-confirmation.tsx` - Show as confirmation card

### Phase 3: Input Forms (1-2 hours)

**Files to Create:**
1. `apps/web/src/features/tools/components/chat-input-form.tsx` - Form component
2. Field components for: date picker, terminal selector, time picker

**Integration:**
- AI can request forms via special tool calls
- Forms render as AI messages with embedded components
- Form submission sends formatted message to AI

---

## Key Component Specifications

### ToolUIContext

```typescript
interface ToolUIContextValue {
  // Expand sheet management
  expandSheet: ExpandSheetData | null;
  openExpandSheet: (data: ExpandSheetData) => void;
  closeExpandSheet: () => void;
  
  // Confirmation dialog
  confirmation: ConfirmationData | null;
  showConfirmation: (data: ConfirmationData) => void;
  closeConfirmation: () => void;
  
  // AI message sending
  sendMessage: (message: string) => void;
  
  // Action/selection handlers
  handleSelection: (selection: ToolSelection) => void;
  handleAction: (action: ToolAction) => void;
}
```

### ToolRendererProps (Enhanced)

```typescript
interface InteractiveToolRendererProps<T = unknown> {
  toolName: string;
  toolCallId: string;
  args: Record<string, unknown>;
  result: T;
  state: "running" | "result" | "error";
  error?: string;
  
  // Interactive handlers
  onAction: (action: ToolAction) => void;
  onSelect: (selection: ToolSelection) => void;
  
  // Display modes
  previewOnly?: boolean;
  previewCount?: number;
  expanded?: boolean;
}
```

### ToolSelection

```typescript
interface ToolSelection {
  type: "slot" | "terminal" | "booking" | "container";
  item: unknown;
  messageToSend: string; // Pre-formatted message for AI
}
```

### ToolAction

```typescript
interface ToolAction {
  type: "view-details" | "cancel-booking" | "confirm-booking" | "retry" | "expand";
  payload: Record<string, unknown>;
  label: string;
  variant?: "default" | "destructive" | "outline";
}
```

---

## Data Flow Examples

### 1. Slot Selection Flow
```
User sees slot grid -> Clicks slot "08:00 Jan 15"
  -> SlotAvailabilityRenderer.onClick()
  -> onSelect({ type: "slot", item: slot, messageToSend: "Je veux le créneau de 08:00 le 15 janvier" })
  -> ToolUIContext.handleSelection()
  -> sendMessage() to AI
  -> AI continues conversation (asks for truck, containers, etc.)
```

### 2. Cancel Booking Flow
```
User sees booking list -> Clicks "Cancel" on a pending booking
  -> onAction({ type: "cancel-booking", payload: { bookingReference: "BK-001" } })
  -> ToolUIContext.handleAction()
  -> showConfirmation({ title: "Annuler?", details: [...], onConfirm: ... })
  -> ConfirmationDialog renders
  -> User clicks "Confirm"
  -> sendMessage("Annule la réservation BK-001")
  -> AI executes cancelBookingViaAI tool
```

### 3. Expand Flow
```
User sees booking list with 3 items + "+7 more"
  -> Clicks expand icon
  -> openExpandSheet({ title: "Réservations (10)", renderFullContent: ... })
  -> ToolExpandSheet (80% width) slides in
  -> Full list with all items + action buttons rendered
```

---

## File Changes Summary

### New Files (9)
```
apps/web/src/features/tools/
├── types.ts                           # Type definitions
├── registry.ts                        # Renamed from index.ts, add metadata
├── context/
│   └── tool-ui-context.tsx           # Context provider
└── components/
    ├── tool-call-renderer.tsx         # Orchestrator
    ├── tool-loading-state.tsx         # Skeleton
    ├── tool-error-state.tsx           # Error card
    ├── tool-expand-sheet.tsx          # 80% modal
    ├── tool-summary-wrapper.tsx       # Summary + expand wrapper
    ├── confirmation-dialog.tsx        # Mutation confirmation
    └── chat-input-form.tsx            # Input collection forms
```

### Modified Files (10)
```
apps/web/src/features/chat/components/
├── chat-view.tsx                      # Wrap with ToolUIProvider
└── chat-message-item.tsx              # Use ToolCallRenderer

apps/web/src/features/tools/components/
├── booking-list.tsx                   # Add interactions
├── booking-details.tsx                # Add interactions
├── slot-availability.tsx              # Make clickable
├── terminal-list.tsx                  # Make selectable
├── container-list.tsx                 # Add actions
├── truck-list.tsx                     # Add actions
├── booking-confirmation.tsx           # Confirmation pattern
└── generic-tool.tsx                   # Update props
```

---

## Verification Plan

### Manual Testing
1. Start the dev server: `pnpm dev`
2. Open chat interface
3. Test each scenario:
   - Ask "Show my bookings" -> Verify card renders with summary + expand
   - Click expand icon -> Verify 80% modal opens
   - Ask "Available slots for tomorrow" -> Verify slots are clickable
   - Click a slot -> Verify message auto-sends to AI
   - On a booking, click "Cancel" -> Verify confirmation dialog appears
   - Confirm -> Verify AI receives cancel request

### Edge Cases to Test
- Empty results (0 bookings, 0 slots)
- Error states (network failure, auth error)
- Loading states (tool running)
- Very long lists (100+ items)
- Mobile viewport (responsive behavior)
- Dark mode styling

---

## Dependencies

No new package dependencies needed. Uses existing:
- `@radix-ui/react-dialog` (already installed)
- `@radix-ui/react-alert-dialog` (already installed)
- `vaul` for Sheet (already installed)
- `react-day-picker` for Calendar (already installed)

---

## Notes

1. **Message Format**: The @convex-dev/agent stores tool calls in `message.content` as array with `type: "tool-call"` parts. The result comes in a separate `type: "tool-result"` part.

2. **Streaming**: Tool results come through real-time Convex subscriptions, so components will automatically update when results arrive.

3. **State Management**: Use React Context (ToolUIContext) at ChatView level to manage modal state and provide sendMessage callback.

4. **Accessibility**: All interactive elements need proper focus management, keyboard navigation, and ARIA labels.
