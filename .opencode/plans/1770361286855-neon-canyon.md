# APCS - Maritime Port Truck Booking System Backend Plan

## Overview
Backend implementation for a centralized maritime port access platform with truck booking, capacity management, and RBAC for Port Admins, Terminal Operators, and Carriers.

---

## Requirements Summary

| Requirement | Decision |
|------------|----------|
| Roles | Extend Better Auth: `port_admin`, `terminal_operator`, `carrier` |
| Operator-Terminal | Many-to-Many relationship |
| Carrier Structure | Company-based (CarrierCompany → Users → Trucks) |
| Time Slots | Flexible intervals (non-overlapping per gate) |
| Booking Changes | Capacity-affecting → Rebook, Others → Modify |
| Cancellation | Configurable window (X hours, -1/0 = disabled) |
| Audit Trail | Full history of all booking changes |
| Notifications | In-app + Email, bilingual EN/FR |
| Booking ID | QR code for gate scanning |

---

## Database Schema (12 Tables)

### Entity Relationships
```
Terminal ──< Gate ──< TimeSlot ──< Booking >── Truck
    │                                │           │
    └──< TerminalOperatorAssignment  │           │
                                     │           │
CarrierCompany ──< CarrierUser       │           │
       │                             │           │
       └─────────────────────────────┴───────────┘
```

### Tables

| Table | Purpose | Key Indexes |
|-------|---------|-------------|
| `terminals` | Port terminals | `by_code`, `by_active` |
| `gates` | Entry gates with capacity rules | `by_terminal`, `by_code` |
| `timeSlots` | Bookable time windows | `by_gate_and_date`, `by_date` |
| `terminalOperatorAssignments` | M:M operators↔terminals | `by_user_and_terminal` |
| `carrierCompanies` | Carrier organizations | `by_code`, `by_active` |
| `carrierUsers` | Links users to carriers | `by_user`, `by_company` |
| `trucks` | Vehicle fleet | `by_carrier_and_active`, `by_license_plate` |
| `bookings` | Slot reservations | `by_reference`, `by_time_slot_and_status`, `by_carrier_and_status` |
| `bookingHistory` | Audit trail | `by_booking`, `by_changed_at` |
| `notifications` | In-app/email alerts | `by_user_and_read`, `by_user_and_type` |
| `systemConfig` | Global settings (singleton) | — |
| `userProfiles` | Extended user data + APCS role | `by_user`, `by_role` |

---

## File Structure

```
packages/backend/convex/
├── schema.ts                 # Full domain schema
├── lib/
│   ├── validators.ts         # Shared validators (roles, status, types)
│   ├── permissions.ts        # RBAC helpers (getAuthenticatedUser, requireRole, canManage*)
│   ├── capacity.ts           # Atomic capacity reservation/release
│   ├── qrcode.ts             # QR code generation
│   └── notifications.ts      # Notification helpers
├── terminals/
│   ├── queries.ts            # list, get
│   └── mutations.ts          # create, update
├── gates/
│   ├── queries.ts            # listByTerminal, get
│   └── mutations.ts          # create, update
├── timeSlots/
│   ├── queries.ts            # getAvailableSlots, getTerminalCapacityOverview
│   ├── mutations.ts          # create, update, bulkCreate
│   └── internal.ts           # overlap validation
├── carriers/
│   ├── queries.ts            # list, get, getMyCompany
│   └── mutations.ts          # create, update, inviteUser
├── trucks/
│   ├── queries.ts            # listByCompany, get
│   └── mutations.ts          # create, update
├── bookings/
│   ├── queries.ts            # list, getByReference, getHistory
│   ├── mutations.ts          # create, updateStatus, changeTimeSlot, changeTruck
│   ├── internal.ts           # generateQrCode, generateBookingReference
│   └── actions.ts            # External API calls
├── notifications/
│   ├── queries.ts            # list, getUnreadCount
│   ├── mutations.ts          # markAsRead, markAllAsRead
│   ├── internal.ts           # sendBookingNotification
│   └── actions.ts            # Email sending (Resend/SendGrid)
├── users/
│   ├── queries.ts            # getProfile, listOperators, listCarrierUsers
│   └── mutations.ts          # createProfile, updateProfile, assignOperator
├── config/
│   ├── queries.ts            # get
│   └── mutations.ts          # update
└── crons.ts                  # Expire bookings, send reminders
```

---

## Implementation Phases

### Phase 1: Schema & Lib (Foundation)
1. **schema.ts** - Full schema with all 12 tables and indexes
2. **lib/validators.ts** - Shared type validators
3. **lib/permissions.ts** - RBAC permission functions

### Phase 2: Core Infrastructure
4. **users/** - User profiles with APCS roles
5. **config/** - System configuration (cancellation window, etc.)
6. **lib/capacity.ts** - Atomic capacity management

### Phase 3: Terminal & Gate Management  
7. **terminals/** - CRUD for terminals
8. **gates/** - CRUD for gates with truck type/class restrictions
9. **timeSlots/** - Slot management with overlap validation

### Phase 4: Carrier & Fleet Management
10. **carriers/** - Carrier company CRUD + user invitations
11. **trucks/** - Truck fleet management

### Phase 5: Booking System
12. **bookings/** - Full booking lifecycle
13. **lib/qrcode.ts** - QR code generation

### Phase 6: Notifications
14. **notifications/** - In-app notifications
15. **notifications/actions.ts** - Email integration

### Phase 7: Scheduled Jobs
16. **crons.ts** - Booking expiration, reminders

---

## Key Implementation Details

### Capacity Management (Atomic)
```typescript
// Reserve capacity atomically
async function checkAndReserveCapacity(ctx, timeSlotId) {
  const slot = await ctx.db.get(timeSlotId);
  if (slot.currentBookings >= slot.maxCapacity) return false;
  await ctx.db.patch(timeSlotId, { 
    currentBookings: slot.currentBookings + 1 
  });
  return true;
}
```

### Booking Status Transitions
```
pending → confirmed (operator validates)
pending → rejected (operator rejects)
pending → cancelled (carrier cancels)
confirmed → consumed (truck enters gate)
confirmed → cancelled (with cancellation window check)
```

### Capacity-Affecting vs Simple Changes
| Change | Type | Action |
|--------|------|--------|
| Time slot change | Capacity-affecting | Release old + reserve new + reset to pending |
| Gate change | Capacity-affecting | Same as time slot |
| Truck change | Simple | Direct patch, no status change |
| Driver info | Simple | Direct patch |

### Permission Checks
- **Port Admin**: Full access to all resources
- **Terminal Operator**: Only assigned terminals (via `terminalOperatorAssignments`)
- **Carrier**: Only own company's resources (via `carrierUsers`)

---

## Verification Plan

### Unit Testing
- Test each mutation with valid/invalid inputs
- Test permission checks for each role
- Test capacity overflow scenarios

### Integration Testing
```bash
# Start Convex dev server
cd packages/backend && npx convex dev

# In another terminal, run tests
bun test
```

### Manual Verification
1. Create terminal → gate → time slots as port_admin
2. Create carrier company → truck as port_admin
3. Create booking as carrier user
4. Confirm booking as terminal_operator
5. Verify capacity decrements correctly
6. Cancel booking and verify capacity restored
7. Check booking history audit trail

---

## Files to Modify

| File | Action |
|------|--------|
| `packages/backend/convex/schema.ts` | Replace with full domain schema |
| `packages/backend/convex/auth.ts` | Add APCS role integration |
| `packages/backend/convex/lib/*` | Create new utilities |
| `packages/backend/convex/{domain}/*` | Create new domain functions |
| `packages/backend/convex/crons.ts` | Create scheduled jobs |

---

## Dependencies to Add

```bash
cd packages/backend
bun add qrcode   # For QR code generation
bun add resend   # For email notifications (or alternative)
```

---

## Notes

- Better Auth already handles authentication; we extend with `userProfiles.apcsRole`
- All queries use indexes for performance
- Mutations are idempotent where possible
- ConvexError used for user-facing errors with codes
- Full audit trail via `bookingHistory` table
- Real-time capacity updates via Convex subscriptions
