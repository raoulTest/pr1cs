# Database Seeding Plan - APCS Port Terminal Management System

## Overview
Create a comprehensive seeding solution for the Convex backend that populates the APCS (Port Terminal Management System) with **realistic Algerian data**, coherent data spanning all 22 tables.

**Location**: Algerian ports (Algiers, Oran, Annaba, Béjaïa, Skikda, Mostaganem, Ghazaouet)
**Timezone**: Africa/Algiers
**Language**: French (as per system requirements)
**Data**: Algerian license plates, driver names, phone numbers, and port infrastructure

## Requirements Summary
- **Volume**: Large (100+ records per main table)
- **Time Range**: Mix of past and future dates
- **Booking Status**: Realistic flow (mostly pending/confirmed, some consumed/cancelled/rejected/expired)
- **Coherence**: All foreign key relationships properly maintained

## Database Architecture (22 Tables)

### Better Auth Tables (5)
1. `user` - Authentication and APCS role (port_admin, terminal_operator, carrier)
2. `session` - User sessions
3. `account` - OAuth accounts
4. `verification` - Email verification tokens
5. `jwks` - JWT signing keys

### APCS Application Tables (17)

#### Core Infrastructure
6. `terminals` - Physical port terminals
7. `gates` - Entry points per terminal
8. `timeSlots` - Bookable time windows
9. `slotTemplates` - Weekly recurring capacity (168 per terminal)

#### User Management
10. `userProfiles` - Extended user data
11. `terminalOperatorAssignments` - Operators to terminals mapping

#### Carrier Assets
12. `trucks` - Fleet vehicles
13. `containers` - Shipping containers (pre-seeded, assigned to carriers)

#### Booking System
14. `bookings` - Time slot reservations
15. `bookingHistory` - Audit trail
16. `notifications` - User notifications
17. `auditLogs` - System audit trail
18. `bookingAggregates` - Pre-computed analytics
19. `systemConfig` - Global settings (singleton)

## Seeding Strategy

### Phase 1: Foundation (Level 1)
**Dependencies**: None

#### 1.1 System Configuration
- **Table**: `systemConfig`
- **Count**: 1 (singleton)
- **Fields**:
  - maxAdvanceBookingDays: 30
  - minAdvanceBookingHours: 2
  - noShowGracePeriodMinutes: 30
  - defaultAutoValidationThreshold: 50
  - reminderHoursBefore: [24, 2]
  - maxContainersPerBooking: 10

#### 1.2 Admin Users (port_admin)
**Note**: Better Auth users must be created via API/signup, not direct DB insert
- **Role**: port_admin
- **Count**: 3
- **Approach**: Document mutation endpoints to call

### Phase 2: Terminal Infrastructure (Level 2)
**Dependencies**: Admin users (for createdBy fields)

#### 2.1 Terminals
- **Table**: `terminals`
- **Count**: 5-8 terminals
- **Sample Data**:
  - Port d'Alger (TER-ALGIERS)
  - Port d'Oran (TER-ORAN)
  - Port d'Annaba (TER-ANNABA)
  - Port de Béjaïa (TER-BEJAIA)
  - Port de Skikda (TER-SKIKDA)
  - Port de Mostaganem (TER-MOSTAGANEM)
  - Port de Ghazaouet (TER-GHAZAOUET)
- **Fields**:
  - name, code (unique), address, timezone (Africa/Algiers)
  - defaultSlotCapacity: 20-50
  - autoValidationThreshold: 30-70%
  - capacityAlertThresholds: [70, 85, 95]
  - operatingHours: 06:00-22:00
- **Auto-creates**: 168 slotTemplates per terminal

#### 2.2 Gates (per terminal)
- **Table**: `gates`
- **Count**: 3-5 gates per terminal (15-40 total)
- **Sample Gate Codes**: GATE-N1, GATE-S1, GATE-E1, GATE-W1, GATE-M1
- **Fields**:
  - name, code (unique per terminal)
  - allowedTruckTypes: [container, flatbed, tanker, refrigerated, bulk, general]
  - allowedTruckClasses: [light, medium, heavy, super_heavy]

#### 2.3 Slot Templates (auto-created)
- **Table**: `slotTemplates`
- **Count**: 168 per terminal (840-1344 total)
- **Fields**:
  - dayOfWeek: 0-6
  - hour: 0-23
  - maxCapacity: inherits from terminal
  - isActive: based on operating hours

### Phase 3: Operational Users (Level 3)
**Dependencies**: Terminals

#### 3.1 Terminal Operators
- **Role**: terminal_operator
- **Count**: 10-15 operators
- **Assignment**: 2-3 operators per terminal via `terminalOperatorAssignments`

#### 3.2 Carrier Users
- **Role**: carrier
- **Count**: 20-30 carriers
- **Approach**: Created via API, collect userIds

### Phase 4: Carrier Assets (Level 4)
**Dependencies**: Carrier users (for ownerId)

#### 4.1 Trucks (per carrier)
- **Table**: `trucks`
- **Count**: 2-5 trucks per carrier (40-150 total)
- **Fields**:
  - licensePlate: Algerian format (12345 123 16)
  - truckType: container, flatbed, tanker, refrigerated, bulk, general
  - truckClass: light, medium, heavy, super_heavy
  - make, model, year, maxWeight

#### 4.2 Containers (pre-seeded, assigned to carriers)
- **Table**: `containers`
- **Count**: 200-500 containers
- **Fields**:
  - containerNumber: ISO 6346 format (MSCU1234567, CMAU7654321)
  - containerType: dry, reefer, open_top, flat_rack, tank, hazardous
  - dimensions: 20ft, 40ft, 40ft_hc, 45ft
  - weightClass: light, medium, heavy, super_heavy
  - operationType: pick_up, drop_off
  - isEmpty: boolean
  - readyDate/departureDate: timestamps

### Phase 5: Bookings (Level 5)
**Dependencies**: Terminals, Gates, Trucks, Containers

#### 5.1 Bookings
- **Table**: `bookings`
- **Count**: 300-500 bookings
- **Time Range**: Past 30 days to Future 30 days
- **Status Distribution (Realistic Flow)**:
  - pending: 10-15%
  - confirmed: 30-40%
  - consumed: 30-40%
  - cancelled: 5-10%
  - rejected: 3-5%
  - expired: 2-5%

**Fields**:
- bookingReference: Auto-generated (TER-XXX-BK-YYYYMMDD-XXXX)
- terminalId, carrierId, truckId, gateId (assigned at confirmation)
- containerIds: 1-4 containers per booking
- preferredDate, preferredTimeStart, preferredTimeEnd
- driverName, driverPhone, driverIdNumber
- status, wasAutoValidated
- Timestamps: bookedAt, confirmedAt, rejectedAt, cancelledAt, consumedAt, expiredAt
- QR code data

#### 5.2 Booking History
- **Table**: `bookingHistory`
- **Count**: 2-5 entries per booking (600-2500 total)
- **Change Types**: created, status_changed, time_slot_changed, truck_changed, driver_updated, details_updated
- Tracks all booking lifecycle events

#### 5.3 Notifications
- **Table**: `notifications`
- **Count**: 500-1000 notifications
- **Types**: booking_created, booking_confirmed, booking_rejected, booking_cancelled, booking_modified, booking_reminder, booking_expired, capacity_alert, system_announcement
- **Channels**: in_app, email, both

#### 5.4 Time Slots (on-demand creation)
- **Table**: `timeSlots`
- **Count**: Created as needed by bookings
- Fields: date, startTime, endTime, maxCapacity, currentBookings

#### 5.5 Audit Logs
- **Table**: `auditLogs`
- **Count**: 1000+ entries
- Tracks all mutations, queries, logins, AI tool calls

#### 5.6 Booking Aggregates
- **Table**: `bookingAggregates`
- **Count**: Pre-computed stats per terminal per day
- Periods: hourly, daily, weekly

## Data Relationships & Constraints

### Foreign Key Dependencies (Creation Order)
```
1. systemConfig (none)
2. Users via API (Better Auth)
3. terminals (requires admin user for createdBy)
   └── auto-creates slotTemplates
4. gates (requires terminalId)
5. terminalOperatorAssignments (requires userId + terminalId)
6. trucks (requires carrier userId as ownerId)
7. containers (requires carrier userId as ownerId)
8. bookings (requires terminalId, carrierId, truckId, containerIds[])
   ├── auto-creates timeSlots (on first booking)
   ├── creates bookingHistory entries
   └── creates notifications
9. bookingAggregates (requires terminalId)
10. auditLogs (optional userId)
```

### Unique Constraints
- `terminals.code` - Unique terminal code
- `gates.code` - Unique per terminal
- `containers.containerNumber` - ISO 6346 format
- `bookings.bookingReference` - Auto-generated unique
- `trucks.licensePlate` - Unique per carrier

### Validation Rules
- Container numbers: 4 letters + 7 digits (e.g., MSCU1234567)
- Time slots: HH:mm format, no overlaps
- Capacity: Cannot exceed maxCapacity
- Status transitions: Enforced by business logic

## Implementation Plan

### File Structure
```
packages/backend/convex/seed/
├── seed.ts                    # Main seeding entry point (mutation)
├── data/
│   ├── terminals.ts           # Terminal definitions
│   ├── gates.ts              # Gate configurations
│   ├── users.ts              # User generation helpers
│   ├── trucks.ts             # Truck generation
│   ├── containers.ts         # Container generation with ISO numbers
│   └── bookings.ts           # Booking generation with realistic flow
└── utils/
    ├── iso6346.ts            # Container number generator
    ├── algerianLicensePlates.ts # Algerian license plate generator
    ├── dates.ts              # Date utilities for past/future
    └── random.ts             # Random selection helpers
```

### Key Implementation Details

#### 1. Container Number Generator (ISO 6346)
```typescript
// Format: 4 letters (owner code) + 6 digits + 1 check digit
// Example: MSCU1234567, CMAU7654321
function generateContainerNumber(ownerCode: string): string {
  const serial = randomDigits(6);
  const checkDigit = calculateCheckDigit(ownerCode, serial);
  return `${ownerCode}${serial}${checkDigit}`;
}
```

#### 2. Algerian License Plate Generator
```typescript
// Format: XXXXX YYY WW (Algerian system)
// XXXXX = 5 digits (vehicle registration)
// YYY = 3 digits (series)
// WW = 2 digits (wilaya/province code: 16=Algiers, 31=Oran, etc.)
// Example: 12345 123 16, 98765 456 31
function generateAlgerianLicensePlate(): string {
  const registration = randomDigits(5);
  const series = randomDigits(3);
  const wilayaCodes = [16, 31, 23, 6, 21, 25, 13]; // Major port cities
  const wilaya = wilayaCodes[Math.floor(Math.random() * wilayaCodes.length)];
  return `${registration} ${series} ${wilaya}`;
}
```

#### 3. Booking Status Assignment (Realistic Flow)
```typescript
function assignRealisticStatus(date: string): BookingStatus {
  const today = new Date();
  const bookingDate = new Date(date);
  const daysDiff = Math.floor((today - bookingDate) / (1000 * 60 * 60 * 24));
  
  if (daysDiff < -7) {
    // Future booking: mostly pending/confirmed
    return weightedRandom(['pending', 'confirmed'], [0.3, 0.7]);
  } else if (daysDiff >= -7 && daysDiff <= 0) {
    // Near future/past few days: confirmed, some consumed
    return weightedRandom(['confirmed', 'consumed', 'cancelled'], [0.5, 0.4, 0.1]);
  } else {
    // Past booking: mostly consumed, some cancelled/expired
    return weightedRandom(['consumed', 'cancelled', 'expired'], [0.75, 0.15, 0.1]);
  }
}
```

#### 4. Algerian Driver Names & Phone Numbers
```typescript
const algerianFirstNames = [
  'Ahmed', 'Mohamed', 'Ali', 'Hassan', 'Omar', 'Khaled', 'Karim', 'Amine',
  'Sofiane', 'Yacine', 'Rachid', 'Nabil', 'Samir', 'Farid', 'Djamel',
  'Fatima', 'Amina', 'Sara', 'Nadia', 'Leila', 'Yasmine', 'Imane', 'Lina',
  'Meriem', 'Sabrina', 'Amel', 'Nawel', 'Djamila', 'Fatiha', 'Samia'
];

const algerianLastNames = [
  'Benali', 'Boudiaf', 'Messaoudi', 'Haddad', 'Kaci', 'Brahimi', 'Amara',
  'Belkacem', 'Hamidi', 'Sahraoui', 'Medjdoub', 'Bensaïd', 'Touati',
  'Zeroual', 'Lounès', 'Djebbour', 'Slimani', 'Gacem', 'Larbi', 'Boualem'
];

function generateAlgerianName(): string {
  const first = algerianFirstNames[Math.floor(Math.random() * algerianFirstNames.length)];
  const last = algerianLastNames[Math.floor(Math.random() * algerianLastNames.length)];
  return `${first} ${last}`;
}

function generateAlgerianPhone(): string {
  // Algerian mobile numbers: 05XX XX XX XX or 06XX XX XX XX or 07XX XX XX XX
  const prefixes = ['05', '06', '07'];
  const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
  const number = randomDigits(8);
  return `+213 ${prefix}${number.slice(0,2)} ${number.slice(2,4)} ${number.slice(4,6)} ${number.slice(6,8)}`;
}
```

#### 5. Time Slot Generation
- Create slots for dates with bookings
- Distribute bookings across different hours (06:00-22:00)
- Respect capacity limits
- Mix of single and multiple containers per booking

### Execution Strategy

#### Step 1: System Config
- Insert single systemConfig record

#### Step 2: Users (Better Auth)
- Document API calls needed to create users
- Store user IDs for subsequent operations

#### Step 3: Terminals & Infrastructure
- Create terminals with realistic data
- Gates automatically created with varied configurations
- SlotTemplates auto-generated (168 per terminal)

#### Step 4: Carrier Assets
- Create trucks for each carrier (2-5 each)
- Create containers with ISO numbers (200-500)
- Mix of pick_up and drop_off operations
- Distribute ready/departure dates

#### Step 5: Bookings with Full Lifecycle
- Create bookings across date range (past 30 days to future 30 days)
- Assign realistic status based on date
- For consumed bookings: add entry/exit scan timestamps
- For confirmed bookings: assign gate using load-balanced algorithm
- Create corresponding bookingHistory entries
- Generate notifications for status changes
- Create audit logs for all operations

#### Step 6: Aggregates
- Pre-compute bookingAggregates per terminal per day

## Coherence Checks

### Data Integrity Verification
1. **Terminal Capacity**: Ensure timeSlot bookings don't exceed maxCapacity
2. **Container Uniqueness**: All container numbers unique and valid ISO 6346
3. **Truck-Gate Compatibility**: Bookings only use trucks compatible with assigned gates
4. **Status Consistency**: Timestamps align with status (e.g., consumed bookings have consumedAt)
5. **Foreign Key Integrity**: All references point to valid records
6. **Date Logic**: Ready dates before departure dates, bookings within operating hours

### Business Rules Validation
1. **Booking Windows**: All bookings within 2h to 30 days window
2. **Max Containers**: No booking exceeds 10 containers
3. **Active Records**: All created records have isActive=true
4. **Operator Assignments**: Each terminal has 2-3 assigned operators
5. **Carrier Assets**: Carriers only have access to their own trucks/containers

## Verification Plan

After seeding, verify:
1. Run `npx convex dev` and check Convex dashboard
2. Query each table to confirm record counts
3. Check foreign key relationships in dashboard
4. Verify booking lifecycle examples end-to-end
5. Test a few queries to ensure data is queryable

## Files to Create/Modify

### New Files
1. `packages/backend/convex/seed/seed.ts` - Main seed mutation
2. `packages/backend/convex/seed/data/terminals.ts` - Terminal definitions
3. `packages/backend/convex/seed/data/gates.ts` - Gate configurations
4. `packages/backend/convex/seed/data/trucks.ts` - Truck generation
5. `packages/backend/convex/seed/data/containers.ts` - Container generation
6. `packages/backend/convex/seed/data/bookings.ts` - Booking generation
7. `packages/backend/convex/seed/utils/iso6346.ts` - ISO container numbers
8. `packages/backend/convex/seed/utils/algerianLicensePlates.ts` - Algerian license plates
9. `packages/backend/convex/seed/utils/dates.ts` - Date utilities
10. `packages/backend/convex/seed/utils/random.ts` - Random helpers

### Documentation
- Update README with seeding instructions
- Document the data model and relationships

## Summary

This plan creates a comprehensive, realistic dataset for the APCS Port Terminal Management System with:
- 5-8 terminals with full infrastructure
- 200-500 containers with valid ISO numbers
- 40-150 trucks across multiple carriers
- 300-500 bookings with realistic status distribution
- Complete audit trail and notification history
- Proper foreign key relationships and business rule compliance

The seeding will be implemented as a Convex mutation that can be run via the CLI or dashboard.
