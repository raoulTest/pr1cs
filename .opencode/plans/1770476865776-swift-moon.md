# Problème: L'agent APCS renvoie trop d'informations en une seule réponse

## Analyse du problème

L'utilisateur a fait **une demande simple**:
> "Je veux reserver un creneau pour demain matin au terminal TC1"

L'agent a répondu avec **une avalanche d'informations**:
- 4+ conteneurs
- 2 camions  
- 7+ terminaux
- Configuration système complète
- Réservations passées
- 5 créneaux disponibles

### Cause racine identifiée

**Le modèle LLM (Gemini) appelle trop d'outils en parallèle** au lieu de procéder étape par étape de manière conversationnelle.

Quand l'utilisateur demande une réservation, l'agent devrait:
1. D'abord identifier/confirmer le terminal (TC1 → TER-ALGIERS ?)
2. Puis montrer les créneaux du **matin** uniquement
3. Demander quel créneau l'utilisateur veut
4. Puis demander les conteneurs/camions

Au lieu de cela, l'agent charge tout en une fois:
- `listTerminals` → 7 terminaux
- `listMyContainers` → 4+ conteneurs  
- `listMyTrucks` → 2 camions
- `getSystemConfig` → toute la configuration
- `listMyBookings` → réservations passées
- `getAvailableSlots` → 5 créneaux

## Fichiers clés

| Fichier | Rôle |
|---------|------|
| `packages/backend/convex/ai/agent.ts` | Définition de l'agent et instructions système |
| `packages/backend/convex/ai/tools/terminals.ts` | Outil getAvailableSlots |
| `packages/backend/convex/ai/tools/bookingFlow.ts` | Outil createBookingViaAI |
| `apps/web/src/features/tools/registry.ts` | Preview counts pour le frontend |

## Solutions proposées

### Option A: Améliorer les instructions système (Recommandé)

Modifier `agent.ts` pour guider l'agent vers un comportement conversationnel:

```typescript
instructions: `...
FLUX DE RÉSERVATION:
Quand l'utilisateur veut faire une réservation, procède ÉTAPE PAR ÉTAPE:
1. Si le terminal n'est pas clair, utilise listTerminals pour identifier le bon
2. Demande confirmation du terminal avant de continuer
3. Utilise getAvailableSlots AVEC le filtre timeOfDay (matin/après-midi) si mentionné
4. Attends que l'utilisateur choisisse un créneau
5. Ensuite SEULEMENT, propose les conteneurs et camions disponibles
6. N'appelle JAMAIS plus de 2 outils à la fois

NE PAS charger toutes les données d'un coup. Être CONVERSATIONNEL.
...`
```

### Option B: Améliorer l'outil getAvailableSlots

Ajouter des paramètres de filtrage:
- `timeOfDay`: "matin" | "apres_midi" | "soir"
- `limit`: nombre max de créneaux à retourner

### Option C: Réduire maxSteps

Actuellement `maxSteps: 5` permet 5 tours d'outils. Réduire à 2-3 forcerait une approche plus séquentielle.

### Option D: Ajouter un outil de workflow guidé

Créer un outil `startBookingFlow` qui guide l'agent à travers les étapes:
```typescript
const startBookingFlow = createTool({
  description: "Démarre un flux de réservation guidé étape par étape",
  args: { terminalHint: z.string().optional(), dateHint: z.string().optional() },
  handler: async (ctx, args) => {
    // Retourne la première étape à faire
    return { step: 1, action: "confirm_terminal", ...}
  }
})
```

## Plan d'implémentation

### Étape 1: Modifier les instructions système

Fichier: `packages/backend/convex/ai/agent.ts`

Ajouter des directives explicites pour:
1. Procéder ÉTAPE PAR ÉTAPE (conversationnel)
2. Ne pas charger toutes les données d'un coup
3. Attendre la confirmation utilisateur entre les étapes
4. Limiter à 1-2 outils par étape

### Nouvelles instructions à ajouter:

```typescript
FLUX DE RÉSERVATION - OBLIGATOIRE:
Quand l'utilisateur veut réserver un créneau, SUIS CES ÉTAPES DANS L'ORDRE:

1. TERMINAL: Identifie le terminal demandé
   - Si ambigu (ex: "TC1"), utilise listTerminals puis DEMANDE confirmation
   - Attends la réponse de l'utilisateur avant de continuer

2. CRÉNEAUX: Une fois le terminal confirmé, montre les créneaux
   - Utilise getAvailableSlots avec le terminal choisi
   - Filtre mentalement par période (matin = avant 12h, après-midi = après 12h)
   - Présente seulement les créneaux pertinents

3. SÉLECTION: Attends que l'utilisateur choisisse un créneau
   - NE PAS proposer conteneurs/camions avant cette étape

4. ÉQUIPEMENT: Après le choix du créneau
   - Propose listMyContainers et listMyTrucks
   - Guide l'utilisateur dans sa sélection

5. CONFIRMATION: Récapitule et confirme avant de créer la réservation

RÈGLES CRITIQUES:
- JAMAIS plus de 2 outils par réponse
- TOUJOURS attendre confirmation utilisateur entre les étapes
- NE PAS charger conteneurs/camions/config avant que l'utilisateur ait choisi un créneau
- Être CONVERSATIONNEL, pas transactionnel
```

## Vérification

Après implémentation, tester:
```
User: "Je veux reserver un creneau pour demain matin au terminal TC1"
```

L'agent devrait:
1. Identifier TC1 → TER-ALGIERS (ou demander clarification)
2. Montrer uniquement les créneaux du matin (06:00-12:00)
3. Attendre la sélection avant de demander conteneurs/camions
