# Plan: Add Global Context to AI Model

## Objective
Inject global context (date/time, user identity) into the AI agent's system prompt so the model has temporal awareness and knows who it's talking to.

## Problem
The APCS agent currently has:
- Static instructions in `agent.ts` (no live date/time)
- Role-based tool permissions in `buildUserContext()` 
- **Missing**: Current date/time, user name/email

For a booking system, this is critical - the model needs to know "today" when interpreting requests like "demain" or "mes reservations".

---

## Implementation

### File to Modify
`packages/backend/convex/ai/chat.ts`

### Changes

#### 1. Add user profile fetching
Extend the existing internal query call to also return user identity info (name, email).

```typescript
// In internalQueries.ts - update getUserRole to also return profile info
export const getUserRole = internalQuery({
  args: { userId: v.string() },
  handler: async (ctx, args) => {
    const authUser = await authComponent.getAnyUserById(ctx, args.userId);
    if (!authUser) return null;
    
    return { 
      role: (authUser as any).role ?? null,
      name: authUser.name,
      email: authUser.email,
    };
  },
});
```

#### 2. Update buildUserContext signature and content
Add a `userInfo` parameter and generate temporal + identity context:

```typescript
interface UserInfo {
  name?: string;
  email?: string;
}

function buildUserContext(role: ApcsRole | null, userInfo?: UserInfo): string {
  // Format current date/time in Morocco timezone (Africa/Casablanca)
  const now = new Date();
  const formatter = new Intl.DateTimeFormat('fr-FR', {
    timeZone: 'Africa/Casablanca',
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
  const dateTimeStr = formatter.format(now);
  const isoDate = now.toISOString().slice(0, 10);
  
  let context = "=== CONTEXTE GLOBAL ===\n";
  context += `Date et heure: ${dateTimeStr}\n`;
  context += `Date ISO: ${isoDate}\n`;
  
  if (userInfo?.name) {
    context += `Utilisateur: ${userInfo.name}\n`;
  }
  if (userInfo?.email) {
    context += `Email: ${userInfo.email}\n`;
  }
  context += "\n";
  
  // ... existing role/tools context ...
}
```

#### 3. Pass user info in handlers
Update `initiateStream` and `generateResponse` to pass the fetched profile:

```typescript
const profile = await ctx.runQuery(internal.ai.internalQueries.getUserRole, { userId: args.userId });
const role = profile?.role as ApcsRole | null;
const context = buildUserContext(role, { 
  name: profile?.name, 
  email: profile?.email 
});
```

---

## Files to Modify

| File | Change |
|------|--------|
| `packages/backend/convex/ai/internalQueries.ts` | Update `getUserRole` to return `name` and `email` |
| `packages/backend/convex/ai/chat.ts` | Add global context (date/time/user) to `buildUserContext()` |

---

## Testing

1. Start dev server: `pnpm dev`
2. Open the chat interface
3. Ask: "quelle est la date?" - should get current date
4. Ask: "mes reservations de demain" - should correctly interpret tomorrow
5. Verify the AI addresses user by name if available

---

## Notes

- Timezone hardcoded to `Africa/Casablanca` (Morocco) - could be made dynamic from terminal timezone if needed
- Date format in French (`fr-FR`) to match the assistant's language
- ISO date included for tool calls that need `YYYY-MM-DD` format
