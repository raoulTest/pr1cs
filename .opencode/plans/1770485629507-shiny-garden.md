# Fix: Sporadic UNAUTHORIZED Errors on Notifications Query

## Problem
User receives `UNAUTHORIZED` error from `notifications/queries:list` even when authenticated, specifically:
1. **On page load/refresh** - race condition
2. **With carrier accounts** - possibly the same issue

## Root Cause

The `useNotifications` hook calls Convex queries **without waiting for authentication state to be ready**.

**File:** `apps/web/src/features/notifications/hooks/use-notifications.ts`

```typescript
// Current code - NO auth guard
const notifications = useQuery(api.notifications.queries.list, {
  limit: options?.limit ?? 20,
  unreadOnly: options?.unreadOnly,
});
```

On page load/refresh, the query fires immediately before the auth token is propagated to the Convex client, causing `ctx.auth.getUserIdentity()` to return `null`, which triggers the UNAUTHORIZED error.

## Solution

Add the `"skip"` pattern to wait for authentication before firing queries.

### File to Modify

**`apps/web/src/features/notifications/hooks/use-notifications.ts`**

```typescript
import { useConvexAuth } from "convex/react";

export function useNotifications(options?: UseNotificationsOptions) {
  const { isAuthenticated } = useConvexAuth();
  
  const notifications = useQuery(
    api.notifications.queries.list, 
    isAuthenticated 
      ? { limit: options?.limit ?? 20, unreadOnly: options?.unreadOnly } 
      : "skip"
  );

  const unreadCount = useQuery(
    api.notifications.queries.unreadCount,
    isAuthenticated ? {} : "skip"
  );

  // rest of the hook unchanged...
}
```

## Why Carriers See This

Carriers see this because they use the app normally and the notifications component is loaded in the app layout. This is the same race condition - it's not a role/permissions issue.

The notification queries:
- **Do NOT restrict by role** - only require authentication  
- **Filter by userId** - users only see their own notifications
- Carriers have full access to their notifications

## Verification

1. Refresh the page - should no longer see UNAUTHORIZED errors
2. Navigate between pages - should not see errors
3. Check both admin and carrier accounts

## Files Involved

| File | Change |
|------|--------|
| `apps/web/src/features/notifications/hooks/use-notifications.ts` | Add `isAuthenticated` check with skip pattern |
