# Notification UI Implementation Plan

## Summary

Add an elegant notification system to the dashboard with a bell icon in the header, displaying real-time notifications from the existing Convex backend.

## Current State

### Backend (Complete)
- **Queries** (`packages/backend/convex/notifications/queries.ts`):
  - `list(unreadOnly?, limit?)` - Get user notifications
  - `unreadCount()` - Get unread count
  - `get(notificationId)` - Get single notification
  - `listByType(type, limit?)` - Filter by type

- **Mutations** (`packages/backend/convex/notifications/mutations.ts`):
  - `markAsRead(notificationId)` - Mark single notification as read
  - `markAllAsRead()` - Mark all as read

- **Notification Types**: `booking_created`, `booking_confirmed`, `booking_rejected`, `booking_cancelled`, `booking_modified`, `booking_reminder`, `booking_expired`, `capacity_alert`, `system_announcement`

### Frontend Layout
- `apps/web/src/components/app-layout.tsx` - Header bar has space for notification bell
- Existing UI components: Popover, Button (xs size), Badge, ScrollArea, Skeleton, Empty

---

## Implementation Plan

### Phase 1: Create Feature Module Structure

Create the notifications feature folder:
```
apps/web/src/features/notifications/
  components/
    notification-bell.tsx       # Bell icon with badge
    notification-popover.tsx    # Dropdown container
    notification-item.tsx       # Individual notification
    notification-list.tsx       # List with scroll
    notification-empty.tsx      # Empty state
    notification-skeleton.tsx   # Loading skeleton
  hooks/
    use-notifications.ts        # Query + mutation hook
  lib/
    notification-utils.ts       # Icons, colors, time formatting
  index.ts                      # Barrel exports
```

### Phase 2: Create Utility Functions

**File**: `apps/web/src/features/notifications/lib/notification-utils.ts`

1. **Notification type to icon mapping** (CalendarCheckIcon, CalendarXIcon, etc.)
2. **Notification type to color class** (green for confirmed, red for rejected, etc.)
3. **French relative time formatter** ("A l'instant", "Il y a 5 min", "Hier", etc.)

### Phase 3: Create Hook

**File**: `apps/web/src/features/notifications/hooks/use-notifications.ts`

```typescript
export function useNotifications(options?: { limit?: number; unreadOnly?: boolean }) {
  const notifications = useQuery(api.notifications.queries.list, {...});
  const unreadCount = useQuery(api.notifications.queries.unreadCount);
  const markAsRead = useMutation(api.notifications.mutations.markAsRead);
  const markAllAsRead = useMutation(api.notifications.mutations.markAllAsRead);
  
  return { notifications, unreadCount, isLoading, markAsRead, markAllAsRead };
}
```

### Phase 4: Create UI Components

#### 4.1 `notification-skeleton.tsx`
- Use existing `Skeleton` component
- Create `NotificationSkeleton` for single item
- Create `NotificationListSkeleton` for list (3-4 items)

#### 4.2 `notification-empty.tsx`
- Use existing `Empty`, `EmptyHeader`, `EmptyMedia`, `EmptyTitle`, `EmptyDescription`
- BellOffIcon as media
- French text: "Aucune notification"

#### 4.3 `notification-item.tsx`
- Button-like clickable area
- Icon from notification type (colored)
- Title (bold if unread)
- Body (truncated to 2 lines)
- Relative time
- Unread indicator (blue dot + subtle background)
- Clicking marks as read

#### 4.4 `notification-list.tsx`
- Uses `ScrollArea` with `max-h-[400px]`
- Renders `NotificationListSkeleton` when loading
- Renders `NotificationEmpty` when empty
- Maps notifications to `NotificationItem`

#### 4.5 `notification-popover.tsx`
- Uses existing `Popover`, `PopoverContent`, `PopoverTrigger`
- Header: "Notifications" title + count badge + "Tout marquer lu" button
- Body: `NotificationList`
- Footer: "Voir toutes les notifications" link (optional)

#### 4.6 `notification-bell.tsx`
- Uses `NotificationPopover` as wrapper
- `Button` with `BellIcon`
- Badge overlay with unread count (red, shows "99+" if > 99)
- Aria-label includes count

### Phase 5: Integrate into Layout

**File**: `apps/web/src/components/app-layout.tsx`

Add to BOTH mobile and desktop headers:
```tsx
import { NotificationBell } from "@/features/notifications";

// In header:
<div className="flex-1" />  {/* Spacer */}
<NotificationBell />
```

---

## Files to Create

| File | Description |
|------|-------------|
| `apps/web/src/features/notifications/lib/notification-utils.ts` | Icons, colors, formatRelativeTime |
| `apps/web/src/features/notifications/hooks/use-notifications.ts` | Combined Convex hook |
| `apps/web/src/features/notifications/components/notification-skeleton.tsx` | Loading states |
| `apps/web/src/features/notifications/components/notification-empty.tsx` | Empty state |
| `apps/web/src/features/notifications/components/notification-item.tsx` | Individual notification |
| `apps/web/src/features/notifications/components/notification-list.tsx` | List container |
| `apps/web/src/features/notifications/components/notification-popover.tsx` | Popover container |
| `apps/web/src/features/notifications/components/notification-bell.tsx` | Bell trigger |
| `apps/web/src/features/notifications/index.ts` | Barrel exports |

## Files to Modify

| File | Change |
|------|--------|
| `apps/web/src/components/app-layout.tsx` | Import and add `NotificationBell` to both mobile (line ~40) and desktop (line ~77) headers |

---

## Design Details

### French UI Text
- "Notifications" - header title
- "Aucune notification" - empty title
- "Vous n'avez pas de nouvelles notifications pour le moment." - empty description
- "Tout marquer lu" - mark all as read button
- "Voir toutes les notifications" - view all link
- Time: "A l'instant", "Il y a X min", "Il y a X h", "Hier", "Il y a X jours"

### Visual Style
- No rounded corners (`rounded-none`) - matches existing components
- Badge color: `bg-destructive` (red) for unread count
- Unread indicator: small blue dot + `bg-primary/5` background
- Popover width: `w-80 sm:w-96`
- Max scroll height: `400px`

### Accessibility
- `aria-label` on bell includes unread count
- Focus visible states on all interactive elements
- Keyboard navigation (Tab, Enter, Escape)

---

## Edge Cases

| Case | Handling |
|------|----------|
| No notifications | Show empty state |
| Loading | Show 4 skeleton items |
| 99+ unread | Badge shows "99+" |
| Long notification text | `line-clamp-2` on body |
| Already read notification clicked | Clicking is no-op (idempotent) |
| Real-time updates | Convex queries are reactive |

---

## Verification

1. **Visual check**: Notification bell appears in header (both mobile & desktop)
2. **Unread badge**: Shows count when there are unread notifications
3. **Click bell**: Popover opens with notifications or empty state
4. **Click notification**: Marks as read, unread indicator disappears
5. **Mark all as read**: All notifications marked, badge disappears
6. **Loading state**: Skeleton appears briefly while loading
7. **Real-time**: New notifications appear automatically
8. **TypeScript**: No type errors in `npm run typecheck`
