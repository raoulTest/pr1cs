# Auth Flow Implementation Plan

## Overview

Restructure the native app from placeholder drawer/tabs into a feature-based architecture with a proper auth-gated flow. Use HeroUI Native for all UI, TanStack Form + Zod for validation, and Better Auth for authentication.

## Target Folder Structure

```
apps/native/
├── app/
│   ├── _layout.tsx                  # MODIFY: Providers + auth redirect (Slot, not Stack)
│   ├── +not-found.tsx               # KEEP as-is
│   ├── (auth)/
│   │   ├── _layout.tsx              # NEW: Stack, headerShown: false
│   │   └── index.tsx                # NEW: Renders <AuthScreen />
│   └── (app)/
│       ├── _layout.tsx              # NEW: Main app layout (Stack or Tabs)
│       └── (tabs)/
│           ├── _layout.tsx          # NEW: Tab navigator (Home tab)
│           └── index.tsx            # NEW: Home screen with user info + sign out
├── features/
│   └── auth/
│       ├── schemas.ts               # NEW: Zod schemas (loginSchema, signupSchema)
│       ├── components/
│       │   ├── auth-screen.tsx      # NEW: HeroUI Tabs container (Login / Sign Up)
│       │   ├── login-form.tsx       # NEW: TanStack Form + HeroUI TextField
│       │   └── signup-form.tsx      # NEW: TanStack Form + HeroUI TextField
│       └── hooks/
│           └── use-auth.ts          # NEW: Wraps useConvexAuth + authClient actions
├── components/
│   └── tabbar-icon.tsx              # KEEP
├── lib/
│   ├── auth-client.ts               # KEEP as-is
│   └── android-navigation-bar.tsx   # KEEP as-is
```

## Files to Delete

- `app/(drawer)/` — entire directory (layout, index, tabs sublayouts, tab screens)
- `app/modal.tsx` — placeholder modal
- `components/sign-in.tsx` — replaced by features/auth
- `components/sign-up.tsx` — replaced by features/auth
- `components/header-button.tsx` — only used by deleted drawer

## Implementation Steps

### Step 1: Create `features/auth/schemas.ts`

Two Zod schemas:
- `loginSchema`: `{ email: z.string().email(), password: z.string().min(8) }`
- `signupSchema`: `{ name: z.string().min(2), email: z.string().email(), password: z.string().min(8) }`
- Export inferred types: `LoginFormValues`, `SignupFormValues`

### Step 2: Create `features/auth/hooks/use-auth.ts`

Hook wrapping:
- `useConvexAuth()` for `{ isAuthenticated, isLoading }`
- `authClient.signIn.email()`, `authClient.signUp.email()`, `authClient.signOut()`
- Returns `{ isAuthenticated, isLoading, signIn, signUp, signOut }`

### Step 3: Create `features/auth/components/login-form.tsx`

- `useForm` from `@tanstack/react-form` with `loginSchema` as `validators.onChange`
- Each field via `form.Field` rendering HeroUI `<TextField isInvalid={...}><Label/><Input onChangeText={field.handleChange} onBlur={field.handleBlur}/><FieldError/></TextField>`
- Password field with eye toggle icon (from HeroUI docs pattern, using Ionicons + Pressable)
- `form.Subscribe` for submit button state (canSubmit, isSubmitting)
- Server errors set via form error map, displayed in a FieldError block
- `onSubmit` calls the `signIn` function from `use-auth` hook

### Step 4: Create `features/auth/components/signup-form.tsx`

Same pattern as login but with 3 fields (name, email, password) and `signupSchema`.

### Step 5: Create `features/auth/components/auth-screen.tsx`

- HeroUI `Tabs` (variant="primary") with two triggers: "Login" and "Sign Up"
- `Tabs.Content` renders `<LoginForm />` and `<SignupForm />`
- Wrapped in `ScrollView` (keyboard avoidance) and `Card`
- Simple app title text above the card
- Uses `KeyboardAvoidingView` for proper form behavior

### Step 6: Create route files

**`app/(auth)/_layout.tsx`**: Stack with `headerShown: false`

**`app/(auth)/index.tsx`**: Imports and renders `<AuthScreen />` from features

**`app/(app)/_layout.tsx`**: Stack layout (or Tabs directly) for authenticated screens

**`app/(app)/(tabs)/_layout.tsx`**: Tab navigator with a Home tab

**`app/(app)/(tabs)/index.tsx`**: Home screen showing user welcome card + sign out button (imports `useQuery(api.auth.getCurrentUser)` and `authClient.signOut`)

### Step 7: Modify `app/_layout.tsx`

- Keep all providers (ConvexBetterAuthProvider, GestureHandlerRootView, HeroUINativeProvider, ThemeProvider)
- Replace `<Stack>` with auth redirect logic:
  - Use `useConvexAuth()`, `useSegments()`, `useRouter()`
  - In `useEffect`: redirect to `/(auth)` if not authenticated, to `/(app)` if authenticated
  - Show centered `Spinner` while `isLoading`
  - Render `<Slot />` (from expo-router)
- Remove `unstable_settings` pointing to `(drawer)`
- Remove the modal Stack.Screen

### Step 8: Delete old files

Delete all files listed in "Files to Delete" section above.

## Key Patterns

### TanStack Form + HeroUI TextField Integration

```tsx
<form.Field name="email">
  {(field) => (
    <TextField
      isRequired
      isInvalid={field.state.meta.isTouched && field.state.meta.errors.length > 0}
    >
      <Label>Email</Label>
      <Input
        value={field.state.value}
        onChangeText={field.handleChange}
        onBlur={field.handleBlur}
        placeholder="you@example.com"
        keyboardType="email-address"
        autoCapitalize="none"
      />
      {field.state.meta.isTouched && field.state.meta.errors.length > 0 && (
        <FieldError>{field.state.meta.errors.join(', ')}</FieldError>
      )}
    </TextField>
  )}
</form.Field>
```

### Auth Redirect Pattern (root layout)

```tsx
const { isAuthenticated, isLoading } = useConvexAuth();
const segments = useSegments();
const router = useRouter();

useEffect(() => {
  if (isLoading) return;
  const inAuth = segments[0] === '(auth)';
  if (!isAuthenticated && !inAuth) router.replace('/(auth)');
  else if (isAuthenticated && inAuth) router.replace('/(app)');
}, [isAuthenticated, isLoading, segments]);
```

## Verification

1. Start the app with `bun run dev` in `apps/native/`
2. Should see the auth screen with Login/Signup tabs
3. Switch between Login and Signup tabs — animated transition
4. Submit empty form — field-level Zod validation errors appear
5. Submit with invalid email — email validation error
6. Submit with short password — password validation error
7. Sign up with valid credentials — redirects to Home screen
8. Home screen shows user info and sign out button
9. Sign out — redirects back to auth screen
10. Sign in with created credentials — redirects to Home screen
