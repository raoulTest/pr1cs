# Chat Interface Fixes Plan

## Summary
Fix 5 issues in the chat interface:
1. Messages showing in reverse order
2. User context appearing in message bubbles
3. User role showing as "unknown"
4. Conversation titles always "New Conversation"
5. Quick actions are static (not role-based)

---

## Issue 1: Messages in Reverse Order

**Root Cause:** The `@convex-dev/agent` `listMessages` function returns messages in descending order by default (newest first for pagination efficiency).

**Fix:** Reverse the messages array on the frontend before rendering.

**File:** `apps/web/src/features/chat/hooks/use-thread.ts`

```typescript
// Line 56 - change from:
const messages = (messagesResult?.page ?? []) as unknown as MessageDoc[];

// To:
const messages = ([...(messagesResult?.page ?? [])].reverse()) as unknown as MessageDoc[];
```

---

## Issue 2: User Context Showing in Message Bubble

**Root Cause:** In `chat.ts`, the `fullPrompt` (which includes USER CONTEXT prefix) is passed directly to `streamText`, causing the entire prompt with context to be saved as the user message.

**Fix:** Pass original user prompt separately and use system message or context injection properly.

**File:** `packages/backend/convex/ai/chat.ts`

**Changes to `initiateStream` (lines 92-121):**
```typescript
export const initiateStream = action({
  args: {
    threadId: v.string(),
    prompt: v.string(),
    userId: v.string(),
  },
  returns: v.null(),
  handler: async (ctx, args) => {
    // Fetch user role and build context
    const profile = await ctx.runQuery(
      internal.ai.internalQueries.getUserRole,
      { userId: args.userId },
    );
    const role = profile?.role as ApcsRole | null;
    const context = buildUserContext(role);

    // Use system message for context, keep user prompt clean
    await apcsAgent.streamText(
      ctx,
      { threadId: args.threadId, userId: args.userId },
      {
        prompt: args.prompt,  // Original prompt only
        system: context,      // Context as system message
      },
      { saveStreamDeltas: true },
    );

    return null;
  },
});
```

**Same change for `generateResponse` (lines 126-151):**
```typescript
const result = await apcsAgent.generateText(
  ctx,
  { threadId: args.threadId, userId: args.userId },
  {
    prompt: args.prompt,  // Original prompt only
    system: context,      // Context as system message
  },
);
```

---

## Issue 3: Role Showing as "unknown"

**Root Cause:** The `getUserRoleHelper` function has two bugs in BOTH files:
1. Uses raw `ctx.db.query("users")` instead of the `authComponent.getAnyUserById()` method
2. Only queries for role if `profile?.preferredLanguage` exists (unnecessary condition)

**Correct Pattern:** Use `authComponent.getAnyUserById(ctx, userId)` as seen in `users/queries.ts:90` and `lib/permissions.ts:45`

### File 1: `packages/backend/convex/ai/internalQueries.ts`

**Add import at top:**
```typescript
import { authComponent } from "../auth";
import type { GenericCtx } from "@convex-dev/better-auth";
import type { DataModel } from "../_generated/dataModel";
```

**Replace `getUserRoleHelper` (lines 37-49):**
```typescript
async function getUserRoleHelper(ctx: { db: any }, userId: string): Promise<string | null> {
  // Use authComponent to query Better Auth user table properly
  const authUser = await authComponent.getAnyUserById(
    ctx as unknown as GenericCtx<DataModel>,
    userId
  );
  if (!authUser) return null;
  
  // Role is on the authUser object (cast needed due to Better Auth typing)
  return (authUser as unknown as { role: string }).role ?? null;
}
```

### File 2: `packages/backend/convex/ai/mutations.ts`

**Add import at top:**
```typescript
import { authComponent } from "../auth";
import type { GenericCtx } from "@convex-dev/better-auth";
import type { DataModel } from "../_generated/dataModel";
```

**Replace `getUserRoleHelper` (around line 19-25):**
```typescript
async function getUserRoleHelper(ctx: { db: any }, userId: string): Promise<string | null> {
  const authUser = await authComponent.getAnyUserById(
    ctx as unknown as GenericCtx<DataModel>,
    userId
  );
  if (!authUser) return null;
  return (authUser as unknown as { role: string }).role ?? null;
}
```

---

## Issue 4: AI-Generated Conversation Titles

**Approach:** After the first user message, generate a title using the same AI model and update the thread.

### Step 4.1: Create title generation action

**File:** `packages/backend/convex/ai/chat.ts`

**Add imports at the top:**
```typescript
import { generateText } from "ai";
import { google } from "@ai-sdk/google";
import { components } from "../_generated/api";
```

**Add new action after `generateResponse`:**
```typescript
/**
 * Generate a title for a thread based on the first message.
 * Called asynchronously after the first message is sent.
 */
export const generateThreadTitle = action({
  args: {
    threadId: v.string(),
    firstMessage: v.string(),
  },
  returns: v.string(),
  handler: async (ctx, args) => {
    const { text } = await generateText({
      model: google("gemini-2.0-flash"),
      prompt: `Generate a very short title (max 5 words, in French) for a conversation that starts with this message: "${args.firstMessage}". Return only the title, no quotes or punctuation.`,
      maxTokens: 20,
    });
    
    const title = text.trim();
    
    // Update thread title using the component's internal mutation
    await ctx.runMutation(components.agent.threads.updateThread, {
      threadId: args.threadId,
      patch: { title },
    });
    
    return title;
  },
});
```

**Note:** The `components.agent.threads.updateThread` mutation accepts `{ threadId: string, patch: { title?: string, summary?: string, ... } }`

### Step 4.2: Trigger title generation after first message

**File:** `apps/web/src/features/chat/hooks/use-thread.ts`

Add title generation call after creating a new thread:
```typescript
const generateTitleAction = useAction(api.ai.chat.generateThreadTitle);

const sendMessage = useCallback(
  async (message: string) => {
    if (!message.trim()) return;
    setStatus("submitted");

    try {
      let currentThreadId = threadId;
      const isNewThread = !currentThreadId;
      
      if (!currentThreadId) {
        currentThreadId = await createThread();
      }

      setStatus("streaming");
      setIsStreaming(true);

      await initiateStreamAction({
        threadId: currentThreadId,
        prompt: message,
        userId,
      });

      // Generate title for new threads (fire and forget)
      if (isNewThread) {
        generateTitleAction({
          threadId: currentThreadId,
          firstMessage: message,
        }).catch(console.error);
      }

      setStatus("ready");
    } catch (error) {
      console.error("Failed to send message:", error);
      setStatus("error");
    } finally {
      setIsStreaming(false);
    }
  },
  [threadId, createThread, initiateStreamAction, generateTitleAction, userId],
);
```

### Step 4.3: Update thread creation to use placeholder

**File:** `packages/backend/convex/ai/chat.ts`

Change default title to empty or placeholder:
```typescript
export const createThread = action({
  // ...
  handler: async (ctx, args) => {
    const { threadId } = await apcsAgent.createThread(ctx, {
      userId: args.userId,
      title: "",  // Empty, will be set after first message
    });
    return threadId;
  },
});
```

---

## Issue 5: Role-Based Quick Actions

**Approach:** Define role-specific suggestions and pass user role to ChatEmptyState.

### Step 5.1: Define role-based suggestions

**File:** `apps/web/src/features/chat/components/chat-empty-state.tsx`

```typescript
import { useRole, type ApcsRole } from "@/hooks/use-role";

// Role-specific suggestions (French)
const ROLE_SUGGESTIONS: Record<ApcsRole, Array<{
  icon: React.ReactNode;
  title: string;
  description: string;
}>> = {
  carrier: [
    {
      icon: <CalendarIcon className="size-4" />,
      title: "Reserver un creneau",
      description: "Je veux reserver un creneau pour demain matin au terminal TC1",
    },
    {
      icon: <TruckIcon className="size-4" />,
      title: "Mes reservations",
      description: "Montre-moi la liste de mes reservations en cours",
    },
    {
      icon: <PackageIcon className="size-4" />,
      title: "Mes conteneurs",
      description: "Quels conteneurs sont disponibles pour une reservation ?",
    },
    {
      icon: <MessageSquareIcon className="size-4" />,
      title: "Annuler une reservation",
      description: "Je veux annuler ma reservation de demain",
    },
  ],
  terminal_operator: [
    {
      icon: <CalendarIcon className="size-4" />,
      title: "Reservations du terminal",
      description: "Montre-moi toutes les reservations du terminal TC1 pour aujourd'hui",
    },
    {
      icon: <ClockIcon className="size-4" />,
      title: "Reservations en attente",
      description: "Quelles reservations sont en attente de validation ?",
    },
    {
      icon: <TruckIcon className="size-4" />,
      title: "Disponibilite des creneaux",
      description: "Quels creneaux sont disponibles demain ?",
    },
    {
      icon: <MessageSquareIcon className="size-4" />,
      title: "Aide generale",
      description: "Comment fonctionne le systeme de reservation ?",
    },
  ],
  port_admin: [
    {
      icon: <BuildingIcon className="size-4" />,
      title: "Vue d'ensemble",
      description: "Montre-moi un resume de l'activite portuaire aujourd'hui",
    },
    {
      icon: <CalendarIcon className="size-4" />,
      title: "Toutes les reservations",
      description: "Liste toutes les reservations en cours sur tous les terminaux",
    },
    {
      icon: <TruckIcon className="size-4" />,
      title: "Reservations par transporteur",
      description: "Montre-moi les reservations du transporteur XYZ",
    },
    {
      icon: <SettingsIcon className="size-4" />,
      title: "Configuration systeme",
      description: "Quelles sont les politiques de reservation actuelles ?",
    },
  ],
};

// Fallback suggestions for unauthenticated/unknown role
const DEFAULT_SUGGESTIONS = [
  {
    icon: <MessageSquareIcon className="size-4" />,
    title: "Aide generale",
    description: "Comment fonctionne le systeme de reservation ?",
  },
];
```

### Step 5.2: Update ChatEmptyState component

```typescript
interface ChatEmptyStateProps {
  onSuggestionClick?: (suggestion: string) => void;
}

export function ChatEmptyState({ onSuggestionClick }: ChatEmptyStateProps) {
  const role = useRole();
  
  // Get role-specific suggestions or fallback
  const suggestions = role 
    ? ROLE_SUGGESTIONS[role] ?? DEFAULT_SUGGESTIONS
    : DEFAULT_SUGGESTIONS;

  return (
    // ... rest of component unchanged
  );
}
```

### Step 5.3: Add missing icon imports

```typescript
import { 
  MessageSquareIcon, 
  TruckIcon, 
  CalendarIcon, 
  PackageIcon,
  ClockIcon,
  BuildingIcon,
  SettingsIcon,
} from "lucide-react";
```

---

## Implementation Order

1. **Issue 3 (Role fix)** - Fix first as other features depend on correct role
2. **Issue 2 (Context in bubbles)** - Critical UX bug
3. **Issue 1 (Message order)** - Simple frontend fix
4. **Issue 5 (Role-based actions)** - Depends on issue 3
5. **Issue 4 (Title generation)** - Independent feature

---

## Files to Modify

| File | Changes |
|------|---------|
| `packages/backend/convex/ai/internalQueries.ts` | Fix `getUserRoleHelper` - use `authComponent.getAnyUserById()` instead of raw query |
| `packages/backend/convex/ai/mutations.ts` | Fix `getUserRoleHelper` - use `authComponent.getAnyUserById()` instead of raw query |
| `packages/backend/convex/ai/chat.ts` | Use system message for context, add title generation action |
| `apps/web/src/features/chat/hooks/use-thread.ts` | Reverse messages, trigger title generation for new threads |
| `apps/web/src/features/chat/components/chat-empty-state.tsx` | Role-based suggestions with useRole hook |

---

## Verification Steps

1. **Role fix:** Log in as a user with a role, send a message - AI should acknowledge your role correctly
2. **Context fix:** Send a message - your message bubble should only show your text, not "USER CONTEXT:..."
3. **Message order:** Send multiple messages - oldest should be at top, newest at bottom
4. **Title generation:** Start a new conversation - title should update from empty to AI-generated title
5. **Quick actions:** Log in as different roles - each should see role-appropriate suggestions

---

## Edge Cases

- **New users without role:** Falls back to "unknown" context, shows default suggestions
- **Title generation failure:** Thread keeps empty title, displays "Nouvelle conversation" in sidebar
- **Empty messages array:** Already handled with `reverse()` on empty array
- **Role loading state:** `useRole()` returns `undefined` while loading - suggestions show default
