# Plan: Migrate Role Management to Better Auth + Auto-Create UserProfiles

## Summary
1. Extend Better Auth user table to include all APCS roles (`port_admin`, `terminal_operator`, `carrier`)
2. Implement `onCreate` trigger to auto-create userProfiles on signup
3. Remove `apcsRole` from userProfiles table (keep for preferences only)
4. Update permission system to read role from Better Auth user instead of userProfiles

---

## Files to Modify

| File | Change |
|------|--------|
| `packages/backend/convex/auth.ts` | Extend roles, implement onCreate trigger |
| `packages/backend/convex/betterAuth/generatedSchema.ts` | Regenerate with new roles |
| `packages/backend/convex/schema.ts` | Remove apcsRole from userProfiles |
| `packages/backend/convex/lib/validators.ts` | Keep apcsRoleValidator for compatibility |
| `packages/backend/convex/lib/permissions.ts` | Read role from Better Auth user, not userProfiles |
| `packages/backend/convex/users/mutations.ts` | Update setRole to use Better Auth admin API |

---

## Implementation Steps

### Step 1: Extend Better Auth Roles

**File: `packages/backend/convex/auth.ts`**

Update `additionalFields.role` to include all APCS roles:

```typescript
user: {
  additionalFields: {
    role: {
      type: ["port_admin", "terminal_operator", "carrier", "user"],
      defaultValue: "user",
      input: false,
    },
  },
},
```

Update access control roles:

```typescript
export const port_admin = ac.newRole({
  ...adminAc.statements,
});

export const terminal_operator = ac.newRole({
  // terminal operators have standard user permissions
});

export const carrier = ac.newRole({
  // carriers have standard user permissions
});
```

Update adminPlugin:

```typescript
adminPlugin({
  adminRoles: ["port_admin"],
  ac: ac,
  roles: {
    port_admin,
    terminal_operator,
    carrier,
  },
}),
```

### Step 2: Implement onCreate Trigger

**File: `packages/backend/convex/auth.ts`**

Implement the empty `onCreate` trigger to auto-create userProfiles:

```typescript
triggers: {
  user: {
    async onCreate(ctx, doc) {
      const now = Date.now();
      await ctx.db.insert("userProfiles", {
        userId: doc._id,
        preferredLanguage: "en",
        notificationChannel: "in_app",
        createdAt: now,
        updatedAt: now,
      });
    },
  },
},
```

### Step 3: Update UserProfiles Schema

**File: `packages/backend/convex/schema.ts`**

Remove `apcsRole` from userProfiles table:

```typescript
userProfiles: defineTable({
  userId: v.string(),
  // apcsRole: REMOVED - now stored in Better Auth user table
  preferredLanguage: languageValidator,
  notificationChannel: notificationChannelValidator,
  phone: v.optional(v.string()),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_user", ["userId"]),
  // Remove: .index("by_role", ["apcsRole"])
```

### Step 4: Update Permission System

**File: `packages/backend/convex/lib/permissions.ts`**

Update `getAuthenticatedUser` to read role from Better Auth user:

```typescript
export async function getAuthenticatedUser(
  ctx: PermissionContext
): Promise<AuthenticatedUser> {
  const authUser = await authComponent.safeGetAuthUser(
    ctx as unknown as GenericCtx<DataModel>
  );

  if (!authUser) {
    throw new ConvexError({
      code: "UNAUTHORIZED",
      message: "You must be logged in to perform this action",
    });
  }

  // Role now comes from Better Auth user, not userProfiles
  const apcsRole = authUser.role as ApcsRole | "user";
  const effectiveRole = apcsRole === "user" ? null : apcsRole;

  // Get extended profile for preferences
  const profile = await ctx.db
    .query("userProfiles")
    .withIndex("by_user", (q) => q.eq("userId", authUser._id))
    .unique();

  // ... rest of carrier association logic stays the same

  return {
    userId: authUser._id as unknown as string,
    email: authUser.email,
    name: authUser.name,
    apcsRole: effectiveRole,
    carrierCompanyId,
    isCompanyAdmin,
  };
}
```

### Step 5: Update Role Assignment Mutation

**File: `packages/backend/convex/users/mutations.ts`**

Update `setRole` mutation to use Better Auth admin API instead of updating userProfiles:

```typescript
export const setRole = mutation({
  args: {
    userId: v.string(),
    role: v.union(
      v.literal("port_admin"),
      v.literal("terminal_operator"),
      v.literal("carrier"),
      v.literal("user")
    ),
  },
  returns: v.null(),
  handler: async (ctx, args) => {
    const user = await getAuthenticatedUser(ctx);
    requireRole(user, ["port_admin"]);

    // Use Better Auth admin API to update role
    // The admin plugin provides setRole functionality
    await authComponent.updateUser(ctx, args.userId, {
      role: args.role,
    });

    return null;
  },
});
```

### Step 6: Regenerate Better Auth Schema

Run the Better Auth CLI to regenerate the schema with new roles:

```bash
cd packages/backend
npx @better-auth/cli generate --output convex/betterAuth/generatedSchema.ts -y
```

---

## Verification

1. **Test user signup**: Create a new user and verify:
   - userProfiles record is auto-created via trigger
   - User has default role "user" in Better Auth

2. **Test role assignment**: As port_admin, assign roles and verify:
   - Role updates in Better Auth user table
   - Permission checks work correctly

3. **Test permissions**: Verify each role can access appropriate resources:
   - `port_admin`: All access
   - `terminal_operator`: Terminal-scoped access
   - `carrier`: Carrier company-scoped access
   - `user`: No APCS access (null apcsRole)

4. **Run TypeScript check**:
   ```bash
   cd packages/backend && npx tsc --noEmit
   ```

5. **Test the app**:
   ```bash
   pnpm dev
   ```

---

## Migration Notes

- Existing users with `apcsRole` in userProfiles will need their roles migrated to Better Auth user table
- Consider writing a one-time migration script to sync existing userProfiles.apcsRole to Better Auth user.role
