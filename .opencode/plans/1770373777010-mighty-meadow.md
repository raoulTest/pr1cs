# Convex Agents Setup Plan

## Overview
Add AI agent capabilities to the existing port logistics system using Convex Agents with **Google Gemini**. The agent will be the **primary interface** - users interact through AI with custom components rendering tool results (booking cards, terminal details, etc.).

## Current State
- Convex backend: ✅ Configured at `packages/backend/convex/`
- Schema: ✅ 12 tables defined (terminals, gates, bookings, etc.)
- Better Auth: ✅ Integrated
- AI UI components: ✅ Already created in `apps/web/src/components/ai-elements/`
- Missing: Backend AI implementation

## Key Requirements
- **AI Provider:** Google Gemini
- **Architecture:** AI-first interface with tool-based interactions
- **Tool Access:** Role-based (different tools for different user roles)
- **Data Retrieval:** Direct database queries (no embeddings/RAG)
- **Extensibility:** Easy to add new tools later

## Implementation Plan

### Phase 1: Install Dependencies
**Files to modify:**
- `packages/backend/package.json`

**Actions:**
1. Install `@convex-dev/agent`, `ai`, and `@google/genai` packages
2. Add environment variable for Google Gemini API key

### Phase 2: Configure Agent Component
**Files to create:**
- `packages/backend/convex/agent.ts` - Main agent configuration with Gemini
- `packages/backend/convex/convex.config.ts` - Add agent component

**Actions:**
1. Initialize Agent with Google Gemini chat model
2. Register agent component in convex.config.ts
3. Configure system prompts for port logistics context

### Phase 3: Update Schema
**Files to modify:**
- `packages/backend/convex/schema.ts`

**Actions:**
1. Add `threads` table for conversation management
2. Add `messages` table for chat history with tool call support
3. Add `toolResults` table for caching tool outputs
4. Store user role in thread metadata for access control

### Phase 4: Thread Management
**Files to create:**
- `packages/backend/convex/threads/queries.ts` - List threads, get messages
- `packages/backend/convex/threads/mutations.ts` - Create threads, delete threads

**Actions:**
1. Create `createThread` mutation with user role metadata
2. Create `listThreads` query (by user)
3. Create `getMessages` query (by thread)
4. Create `deleteThread` mutation

### Phase 5: Chat Implementation
**Files to create:**
- `packages/backend/convex/chat/actions.ts` - Send message, streaming
- `packages/backend/convex/chat/mutations.ts` - Internal mutations

**Actions:**
1. Create `sendMessage` action with streaming support
2. Implement tool calling with streaming responses
3. Handle user and assistant message persistence
4. Add rate limiting for cost control

### Phase 6: Tool Architecture
**Files to create:**
- `packages/backend/convex/tools/registry.ts` - Tool registry with role-based filtering
- `packages/backend/convex/tools/types.ts` - Shared tool types
- `packages/backend/convex/tools/bookings.ts` - Booking-related tools
- `packages/backend/convex/tools/terminals.ts` - Terminal information tools
- `packages/backend/convex/tools/config.ts` - System configuration tools

**Actions:**
1. Create tool registry that filters by user role
2. Define base tool types and interfaces
3. Create example tools for each category:
   - **Booking Tools:** searchBookings, getBookingDetails, createBooking
   - **Terminal Tools:** getTerminals, getTerminalDetails, getAvailableSlots
   - **Config Tools:** getSystemConfig, getPolicies

### Phase 7: Role-Based Access Control
**Files to create:**
- `packages/backend/convex/tools/permissions.ts` - Role-based tool permissions

**Actions:**
1. Define which tools each role can access:
   - `carrier`: View own bookings, create bookings, view terminals
   - `terminal_operator`: View all bookings for their terminals, manage gates
   - `port_admin`: All tools including system configuration
2. Implement permission checking in tool registry

### Phase 8: React Components
**Files to create/modify:**
- `apps/web/src/components/chat/ChatInterface.tsx` - Main chat UI
- `apps/web/src/components/chat/ThreadList.tsx` - Conversation list
- `apps/web/src/components/chat/ToolResultRenderer.tsx` - Renders tool results with custom components
- `apps/web/src/components/chat/tool-renderers/BookingCard.tsx` - Render booking details
- `apps/web/src/components/chat/tool-renderers/TerminalInfo.tsx` - Render terminal details
- `apps/web/src/components/chat/tool-renderers/SlotList.tsx` - Render available slots
- `apps/web/src/routes/_layout/assistant.tsx` - Assistant page route

**Actions:**
1. Create ChatInterface with streaming support
2. Create ThreadList sidebar
3. Create ToolResultRenderer that maps tool names to custom components
4. Create example component renderers for each tool type
5. Add route for /assistant page

### Phase 9: Example Workflows
**Files to create:**
- `packages/backend/convex/workflows/bookingWorkflow.ts` - Multi-step booking assistance

**Actions:**
1. Create workflow for booking creation
2. Show how tools can be chained together
3. Demonstrate complex interactions

## Critical Files Summary

### New Files (15 files)
1. `packages/backend/convex/agent.ts` - Gemini configuration
2. `packages/backend/convex/threads/queries.ts`
3. `packages/backend/convex/threads/mutations.ts`
4. `packages/backend/convex/chat/actions.ts`
5. `packages/backend/convex/chat/mutations.ts`
6. `packages/backend/convex/tools/registry.ts` - Tool registry with permissions
7. `packages/backend/convex/tools/types.ts` - Shared types
8. `packages/backend/convex/tools/bookings.ts` - Booking tools
9. `packages/backend/convex/tools/terminals.ts` - Terminal tools
10. `packages/backend/convex/tools/config.ts` - Config tools
11. `packages/backend/convex/tools/permissions.ts` - Role-based access
12. `apps/web/src/components/chat/ChatInterface.tsx`
13. `apps/web/src/components/chat/ToolResultRenderer.tsx`
14. `apps/web/src/components/chat/tool-renderers/BookingCard.tsx`
15. `apps/web/src/routes/_layout/assistant.tsx`

### Modified Files (3 files)
1. `packages/backend/convex/schema.ts` - Add threads, messages tables
2. `packages/backend/convex/convex.config.ts` - Add agent component
3. `packages/backend/package.json` - Add dependencies

### React Components (5 files)
1. `apps/web/src/components/chat/ChatInterface.tsx`
2. `apps/web/src/components/chat/ThreadList.tsx`
3. `apps/web/src/components/chat/ToolResultRenderer.tsx`
4. `apps/web/src/components/chat/tool-renderers/BookingCard.tsx`
5. `apps/web/src/components/chat/tool-renderers/TerminalInfo.tsx`

## Environment Variables Required
```
GOOGLE_GENERATIVE_AI_API_KEY=...
```

## Verification Steps

1. **Installation Verification:**
   ```bash
   cd packages/backend && bun install
   ```

2. **Schema Verification:**
   ```bash
   cd packages/backend && bunx convex dev
   # Check console for schema errors
   ```

3. **Type Generation:**
   ```bash
   cd packages/backend && bunx convex codegen
   ```

4. **End-to-End Testing:**
   - Navigate to /assistant page
   - Create a new thread
   - Send test messages as different roles
   - Test tool calling ("Show me my bookings", "List terminals")
   - Verify custom component rendering
   - Confirm role-based access works

5. **Architecture Validation:**
   - Verify tool registry filters by role
   - Check that adding new tools is straightforward
   - Ensure tool results render with correct components

## Success Criteria
- [ ] Agent component installed with Google Gemini
- [ ] Threads persist in Convex database
- [ ] Messages stream in real-time
- [ ] Role-based tool access works correctly
- [ ] Tools return data that's rendered with custom components
- [ ] Easy to add new tools following the established pattern
- [ ] No TypeScript errors
- [ ] All Convex functions type-safe

## Tool Examples Included

The implementation will include examples of each tool type you'll need:

1. **Query Tools** (read data):
   - `searchBookings` - Search with filters
   - `getTerminalDetails` - Get single record
   - `getAvailableSlots` - Query with date range

2. **Mutation Tools** (create/update):
   - `createBooking` - Create new record
   - `updateBooking` - Update existing record

3. **Config Tools** (system settings):
   - `getSystemConfig` - Read configuration
   - `getPolicies` - Get business rules

Each tool will demonstrate:
- Proper typing
- Error handling
- Role-based access
- Component rendering
